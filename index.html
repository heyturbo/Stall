<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©ä¹¦å°æ‘Š - ç»å•†æ¨¡æ‹Ÿæ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        #game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #8B4513;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        h2 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }

        .section-toggle {
            cursor: pointer;
            margin-right: 10px;
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        #currency-display {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .currency-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            margin: 5px;
            background-color: #f9f9f9;
            flex: 1;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .currency-item p {
            position: relative;
            z-index: 2;
        }

        .currency-special {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.8em;
            opacity: 0.7;
            z-index: 1;
        }

        .gold {
            background-color: #FFEB99;
        }

        .silver {
            background-color: #E0E0E0;
        }

        section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .section-content {
            max-height: 2000px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .flex-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .flex-section {
            flex: 1;
            min-width: 300px;
        }

        #store-tabs {
            display: flex;
            margin-bottom: 20px;
        }

        #store-tabs button {
            flex: 1;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        #store-tabs button:hover {
            background-color: #e0e0e0;
        }

        #store-tabs button.active {
            background-color: #8B4513;
            color: white;
        }

        .store-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative;
            overflow: hidden;
        }

        .price-trend {
            position: absolute;
            top: 0;
            right: 0;
            padding: 5px;
            font-size: 0.8em;
            color: white;
            border-bottom-left-radius: 5px;
        }

        .price-up {
            background-color: #4CAF50;
        }

        .price-down {
            background-color: #F44336;
        }

        .price-stable {
            background-color: #9E9E9E;
        }

        .item-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .item-details {
            flex: 1;
        }

        .item-price {
            margin-left: 15px;
            font-weight: bold;
        }

        .item-actions {
            margin-left: 15px;
        }

        button {
            padding: 8px 15px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #a0522d;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #gold-egg-section {
            text-align: center;
        }

        #gold-egg {
            font-size: 5em;
            cursor: pointer;
            transition: transform 0.3s;
            display: inline-block;
        }

        #gold-egg:hover {
            transform: scale(1.1);
        }

        #inventory-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #inventory-title {
            width: 100%;
        }

        .inventory-item {
            flex: 1;
            min-width: 200px;
            margin: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .conversion-option {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
        }

        .notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #f8f8f8;
            border-left: 4px solid #8B4513;
        }

        .market-news {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }

        .market-news h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .event-notification {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background-color: #FFF8E1;
            border-left: 4px solid #FFC107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #8B4513;
            width: 0%;
            transition: width 0.3s;
        }

        .stats-display {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-item {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            background-color: #f0f0f0;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Game container -->
    <div id="game-container">
        <!-- Header -->
        <header>
            <h1>å¤©ä¹¦å°æ‘Š</h1>
            <div id="currency-display">
                <!-- Currency information will go here -->
            </div>
            <!-- Stats display -->
            <div class="stats-display">
                <div class="stat-item">
                    <h4>å•†ä¸šç­‰çº§</h4>
                    <p id="business-level">1</p>
                </div>
                <div class="stat-item">
                    <h4>å£°æœ›</h4>
                    <p id="reputation">0</p>
                </div>
                <div class="stat-item">
                    <h4>æ—¥æœŸ</h4>
                    <p id="game-date">ç¬¬1å¹´ æ˜¥</p>
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="level-progress" class="progress-bar" style="width: 0%"></div>
            </div>
        </header>
        
        <!-- Main game area -->
        <main>
            <!-- Market news -->
            <section id="news-section">
                <h2><span class="section-toggle">ğŸ“°</span>å¸‚åœºåŠ¨æ€</h2>
                <div class="section-content">
                    <div class="market-news">
                        <h3>æœ€æ–°æ¶ˆæ¯</h3>
                        <p id="market-news-content">æ¬¢è¿æ¥åˆ°å¤©ä¹¦å°æ‘Šï¼å¸‚åœºç¨³å®šï¼Œå„ç±»å•†å“ä»·æ ¼æ­£å¸¸ã€‚</p>
                    </div>
                    <div id="event-container">
                        <!-- Random events will go here -->
                    </div>
                </div>
            </section>
            
            <!-- Currency section -->
            <section id="currency-section">
                <h2><span class="section-toggle">ğŸ’°</span>é’±åº„</h2>
                <div class="section-content collapsed">
                    <!-- Currency conversion options -->
                </div>
            </section>
            
            <!-- Gold egg gambling section -->
            <section id="gold-egg-section">
                <h2><span class="section-toggle">ğŸ¥š</span>é‡‘è›‹æŠ½å¥–</h2>
                <div class="section-content collapsed">
                    <!-- Gold egg gambling mechanics -->
                </div>
            </section>
            
            <!-- Stores and Inventory in flex container -->
            <div class="flex-container">
                <!-- Stores section -->
                <section id="stores-section" class="flex-section">
                    <h2>å•†åº—</h2>
                    <!-- Store tabs -->
                    <div id="store-tabs">
                        <button id="gold-store-tab">é‡‘åº—</button>
                        <button id="silver-ingot-store-tab">é“¶é”­åº—</button>
                        <button id="silver-note-store-tab">é“¶ç¥¨åº—</button>
                    </div>
                    
                    <!-- Store content -->
                    <div id="store-content">
                        <!-- Store items will go here -->
                    </div>
                </section>
                
                <!-- Inventory section -->
                <section id="inventory-section" class="flex-section">
                    <h2 id="inventory-title">åº“å­˜</h2>
                    <!-- Player's inventory will go here -->
                </section>
            </div>
        </main>
        
        <!-- Footer -->
        <footer>
            <p>å¤©ä¹¦å°æ‘Š - ç»å•†æ¨¡æ‹Ÿæ¸¸æˆ</p>
        </footer>
    </div>

    <script>
        // Game state
        const gameState = {
            currencies: {
                goldIngot: 50 * 1000, // 50 tael = 50,000 wen
                goldNote: 0,
                silverIngot: 0,
                silverNote: 0
            },
            inventory: {},
            activeStore: 'gold',
            eggCost: 5 * 1000, // 5 tael = 5,000 wen
            businessLevel: 1,
            reputation: 0,
            levelProgress: 0,
            date: {
                year: 1,
                season: 0 // 0-Spring, 1-Summer, 2-Autumn, 3-Winter
            },
            marketTrends: {},
            events: [],
            sectionCollapsed: {
                currency: true,
                goldEgg: true,
                news: false
            },
            // Special currency effects
            currencyEffects: {
                goldIngot: {
                    name: "é»„é‡‘å‚¨å¤‡",
                    effect: "ä¿å€¼ï¼Œä»·æ ¼ç¨³å®šï¼Œæå°‘è´¬å€¼",
                    bonus: "è´­ä¹°åŠ›+10%"
                },
                goldNote: {
                    name: "ä¿¡èª‰æŠ•èµ„",
                    effect: "é£é™©æ›´é«˜çš„æŠ•èµ„ç±»è´§å¸",
                    bonus: "æŠ•èµ„å›æŠ¥+20%"
                },
                silverIngot: {
                    name: "æµé€šè´§å¸",
                    effect: "ä¾¿äºæ—¥å¸¸äº¤æ˜“",
                    bonus: "äº¤æ˜“é€Ÿåº¦+15%"
                },
                silverNote: {
                    name: "å¸‚åœºæŠ•æœº",
                    effect: "å—å¸‚åœºæ³¢åŠ¨å½±å“å¤§",
                    bonus: "å¸‚åœºæƒ…æŠ¥+25%"
                }
            }
        };

        // Store items with price fluctuation metadata (prices in wen)
        const storeItems = {
            gold: [
                { id: 'ancient_book', name: 'å¤ç±', icon: 'ğŸ“œ', price: 100 * 1000, basePrice: 100 * 1000, currency: 'goldIngot', resalePrice: 80 * 1000, volatility: 0.1, trend: 0, rarity: 3 },
                { id: 'jade', name: 'ç‰çŸ³', icon: 'ğŸ§©', price: 50 * 1000, basePrice: 50 * 1000, currency: 'goldIngot', resalePrice: 40 * 1000, volatility: 0.2, trend: 0, rarity: 2 },
                { id: 'tea', name: 'çè´µèŒ¶å¶', icon: 'ğŸµ', price: 30 * 1000, basePrice: 30 * 1000, currency: 'goldIngot', resalePrice: 25 * 1000, volatility: 0.3, trend: 0, rarity: 1 },
                { id: 'painting', name: 'åå®¶å­—ç”»', icon: 'ğŸ–¼ï¸', price: 150 * 1000, basePrice: 150 * 1000, currency: 'goldIngot', resalePrice: 120 * 1000, volatility: 0.15, trend: 0, rarity: 4 },
                { id: 'gold_jewelry', name: 'é‡‘é¥°', icon: 'ğŸ’', price: 80 * 1000, basePrice: 80 * 1000, currency: 'goldNote', resalePrice: 70 * 1000, volatility: 0.25, trend: 0, rarity: 3 },
                { id: 'silk', name: 'ä¸ç»¸', icon: 'ğŸ§¶', price: 60 * 1000, basePrice: 60 * 1000, currency: 'goldNote', resalePrice: 50 * 1000, volatility: 0.2, trend: 0, rarity: 2 },
                { id: 'spice', name: 'ç¨€æœ‰é¦™æ–™', icon: 'ğŸŒ¶ï¸', price: 40 * 1000, basePrice: 40 * 1000, currency: 'goldNote', resalePrice: 30 * 1000, volatility: 0.3, trend: 0, rarity: 2 },
            ],
            silverIngot: [
                { id: 'bronze_vessel', name: 'é“œå™¨', icon: 'ğŸº', price: 500 * 1000, basePrice: 500 * 1000, currency: 'silverIngot', resalePrice: 400 * 1000, volatility: 0.25, trend: 0, rarity: 3 },
                { id: 'wine', name: 'è€é…’', icon: 'ğŸ¶', price: 300 * 1000, basePrice: 300 * 1000, currency: 'silverIngot', resalePrice: 250 * 1000, volatility: 0.3, trend: 0, rarity: 2 },
                { id: 'calligraphy', name: 'ä¹¦æ³•', icon: 'âœ’ï¸', price: 700 * 1000, basePrice: 700 * 1000, currency: 'silverIngot', resalePrice: 600 * 1000, volatility: 0.2, trend: 0, rarity: 4 },
                { id: 'medicine', name: 'è¯æ', icon: 'ğŸŒ¿', price: 250 * 1000, basePrice: 250 * 1000, currency: 'silverIngot', resalePrice: 200 * 1000, volatility: 0.35, trend: 0, rarity: 2 },
                { id: 'silver_jewelry', name: 'é“¶é¥°', icon: 'âš±ï¸', price: 350 * 1000, basePrice: 350 * 1000, currency: 'silverIngot', resalePrice: 300 * 1000, volatility: 0.25, trend: 0, rarity: 3 },
            ],
            silverNote: [
                { id: 'fruit', name: 'æ°´æœ', icon: 'ğŸ', price: 50 * 1000, basePrice: 50 * 1000, currency: 'silverNote', resalePrice: 40 * 1000, volatility: 0.4, trend: 0, rarity: 1 },
                { id: 'candies', name: 'ç³–æœ', icon: 'ğŸ¬', price: 30 * 1000, basePrice: 30 * 1000, currency: 'silverNote', resalePrice: 25 * 1000, volatility: 0.35, trend: 0, rarity: 1 },
                { id: 'paper', name: 'çº¸å¼ ', icon: 'ğŸ“ƒ', price: 20 * 1000, basePrice: 20 * 1000, currency: 'silverNote', resalePrice: 15 * 1000, volatility: 0.3, trend: 0, rarity: 1 },
                { id: 'incense', name: 'é¦™', icon: 'ğŸ§¨', price: 40 * 1000, basePrice: 40 * 1000, currency: 'silverNote', resalePrice: 30 * 1000, volatility: 0.35, trend: 0, rarity: 2 },
                { id: 'luxury_food', name: 'çé¦ç¾é£Ÿ', icon: 'ğŸ²', price: 100 * 1000, basePrice: 100 * 1000, currency: 'silverNote', resalePrice: 80 * 1000, volatility: 0.45, trend: 0, rarity: 3 },
                { id: 'foreign_trinket', name: 'å¼‚åŸŸå°ç‰©', icon: 'ğŸ§¸', price: 70 * 1000, basePrice: 70 * 1000, currency: 'silverNote', resalePrice: 55 * 1000, volatility: 0.4, trend: 0, rarity: 2 },
            ]
        };

        // Market events that can affect prices
        const marketEvents = [
            {
                name: "ä¸°æ”¶",
                description: "ä»Šå¹´ä½œç‰©ä¸°æ”¶ï¼Œå¸‚åœºç¹è£ï¼Œå„ç±»å•†å“ä»·æ ¼è¶‹äºç¨³å®šã€‚",
                effect: {
                    type: "global",
                    volatility: -0.1,
                    trend: 0.05
                },
                duration: 2
            },
            {
                name: "æ—±ç¾",
                description: "è¿‘æœŸå¹²æ—±ä¸¥é‡ï¼Œå†œä½œç‰©æ­‰æ”¶ï¼Œå¸‚åœºæ³¢åŠ¨åŠ å‰§ã€‚",
                effect: {
                    type: "category",
                    target: "silverNote",
                    volatility: 0.2,
                    trend: 0.1
                },
                duration: 1
            },
            {
                name: "æˆ˜äº‹æ¶ˆæ¯",
                description: "è¾¹å¢ƒä¼ æ¥æˆ˜äº‹æ¶ˆæ¯ï¼Œè´µé‡ç‰©å“ä»·æ ¼ä¸Šæ¶¨ï¼Œå¸‚åœºææ…ŒåŠ å‰§ã€‚",
                effect: {
                    type: "category",
                    target: "gold",
                    volatility: 0.15,
                    trend: 0.2
                },
                duration: 3
            },
            {
                name: "å®˜å‘˜ä¸‹ä¹¡",
                description: "æœå»·å®˜å‘˜ä¸‹ä¹¡å·¡è§†ï¼Œæ‰‹å·¥è‰ºå“åŠé“œå™¨éœ€æ±‚ä¸Šæ¶¨ã€‚",
                effect: {
                    type: "items",
                    target: ["bronze_vessel", "calligraphy", "silk"],
                    trend: 0.3
                },
                duration: 1
            },
            {
                name: "å¤–å•†æ¥è®¿",
                description: "å¤–å›½å•†é˜ŸæŠµè¾¾ï¼Œå¯¹å¼‚åŸŸç‰©å“å’Œç¨€æœ‰é¦™æ–™éœ€æ±‚å¤§å¢ã€‚",
                effect: {
                    type: "items",
                    target: ["spice", "foreign_trinket", "silk"],
                    trend: 0.25
                },
                duration: 2
            },
            {
                name: "èŠ‚åº†æ¥ä¸´",
                description: "é‡è¦èŠ‚æ—¥å³å°†åˆ°æ¥ï¼Œäººä»¬äº‰ç›¸è´­ä¹°ç¤¼å“å’Œé£Ÿç‰©ï¼Œä»·æ ¼æ°´æ¶¨èˆ¹é«˜ã€‚",
                effect: {
                    type: "items",
                    target: ["candies", "luxury_food", "fruit", "tea"],
                    trend: 0.2
                },
                duration: 1
            },
            {
                name: "é›…é›†æ´»åŠ¨",
                description: "æœ¬åœ°æ–‡äººä¸¾åŠé›…é›†ï¼Œå¯¹ä¹¦æ³•ã€å­—ç”»å’Œå¤ç±éœ€æ±‚å¢åŠ ã€‚",
                effect: {
                    type: "items",
                    target: ["ancient_book", "calligraphy", "painting"],
                    trend: 0.2
                },
                duration: 2
            },
            {
                name: "ç˜Ÿç–«ä¼ è¨€",
                description: "åŠé—´æµä¼ ç˜Ÿç–«æ¶ˆæ¯ï¼Œè¯æä»·æ ¼é£™å‡ï¼Œå¸‚åœºææ…Œã€‚",
                effect: {
                    type: "items",
                    target: ["medicine", "tea"],
                    trend: 0.4
                },
                duration: 2
            },
            {
                name: "æœå»·æ”¶ç¨",
                description: "æœå»·å¼€å§‹æ”¶ç¨ï¼Œæ°‘é—´æµåŠ¨èµ„é‡‘å‡å°‘ï¼Œå¥¢ä¾ˆå“ä»·æ ¼ä¸‹é™ã€‚",
                effect: {
                    type: "items",
                    target: ["gold_jewelry", "jade", "painting", "silver_jewelry"],
                    trend: -0.15
                },
                duration: 1
            },
            {
                name: "è´§å¸è´¬å€¼",
                description: "é“¶ç¥¨ä¿¡ç”¨ä¸‹é™ï¼Œäººä»¬çº·çº·è´­ä¹°å®ç‰©ä¿å€¼ã€‚",
                effect: {
                    type: "currency",
                    target: "silverNote",
                    multiplier: 0.8
                },
                duration: 2
            },
            {
                name: "é‡‘ç¥¨å‡å€¼",
                description: "é‡‘ç¥¨å—åˆ°å¸‚åœºè¿½æ§ï¼Œä½¿ç”¨é‡‘ç¥¨äº¤æ˜“æ›´åˆ’ç®—ã€‚",
                effect: {
                    type: "currency",
                    target: "goldNote",
                    multiplier: 1.2
                },
                duration: 2
            }
        ];

        // Random gameplay events
        const gameEvents = [
            {
                name: "è´µå®¢ä¸Šé—¨",
                description: "ä¸€ä½å¯Œå•†æ¥åˆ°ä½ çš„æ‘Šä½ï¼Œä»–æ„¿æ„ä»¥é«˜ä»·è´­ä¹°ä½ çš„ç¨€æœ‰ç‰©å“ã€‚",
                options: [
                    {
                        text: "æ¥å—äº¤æ˜“",
                        effect: () => {
                            // Find rare items in inventory
                            const rareItems = Object.values(gameState.inventory).filter(item => item.rarity >= 3);
                            if (rareItems.length > 0) {
                                // Sell the first rare item at double price
                                const item = rareItems[0];
                                gameState.inventory[item.id].quantity -= 1;
                                
                                // Higher sale price
                                const bonus = item.resalePrice * 2;
                                
                                // Add currency
                                if (item.currency === 'goldIngot') {
                                    gameState.currencies.goldIngot += bonus;
                                } else if (item.currency === 'goldNote') {
                                    gameState.currencies.goldNote += bonus;
                                } else if (item.currency === 'silverIngot') {
                                    gameState.currencies.silverIngot += bonus;
                                } else {
                                    gameState.currencies.silverNote += bonus;
                                }
                                
                                // Remove from inventory if quantity is 0
                                if (gameState.inventory[item.id].quantity === 0) {
                                    delete gameState.inventory[item.id];
                                }
                                
                                showNotification(`è´µå®¢ååˆ†æ»¡æ„ï¼Œç»™äº†ä½ åŒå€çš„ä»·æ ¼ï¼å£°æœ›+10`);
                                gameState.reputation += 10;
                                return true;
                            } else {
                                showNotification("ä½ æ²¡æœ‰ç¨€æœ‰ç‰©å“å¯ä»¥å‡ºå”®ï¼Œè´µå®¢å¤±æœ›ç¦»å»ã€‚");
                                return false;
                            }
                        }
                    },
                    {
                        text: "å©‰æ‹’",
                        effect: () => {
                            showNotification("ä½ å©‰æ‹’äº†è´µå®¢ï¼Œä»–ç†è§£ä½ çš„å†³å®šï¼Œç»™äº†ä½ ä¸€äº›é“¶ç¥¨ä½œä¸ºç¤¼ç‰©ã€‚");
                            gameState.currencies.silverNote += 10000;
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "å°å·å…‰é¡¾",
                description: "ä¸€ä¸ªå°å·è¯•å›¾å·èµ°ä½ çš„ä¸€äº›è´§ç‰©ï¼Œä½ æ³¨æ„åˆ°äº†ä»–çš„è¡Œä¸ºã€‚",
                options: [
                    {
                        text: "æŠ“ä½å°å·",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.7) {
                                showNotification("ä½ æˆåŠŸæŠ“ä½äº†å°å·ï¼Œå®ˆå«ç»™äº†ä½ å¥–åŠ±ã€‚å£°æœ›+15");
                                gameState.currencies.silverIngot += 20000;
                                gameState.reputation += 15;
                            } else {
                                showNotification("ä½ è¯•å›¾æŠ“ä½å°å·ï¼Œä½†ä»–é€ƒèµ°äº†ï¼Œè¿˜å¸¦èµ°äº†ä¸€äº›è´§ç‰©ã€‚");
                                
                                // Lose a random item
                                const inventoryIds = Object.keys(gameState.inventory);
                                if (inventoryIds.length > 0) {
                                    const randomItemId = inventoryIds[Math.floor(Math.random() * inventoryIds.length)];
                                    gameState.inventory[randomItemId].quantity -= 1;
                                    
                                    if (gameState.inventory[randomItemId].quantity === 0) {
                                        delete gameState.inventory[randomItemId];
                                    }
                                }
                            }
                            return true;
                        }
                    },
                    {
                        text: "æ‚„æ‚„æ”¾èµ°",
                        effect: () => {
                            showNotification("ä½ é€‰æ‹©æ”¾èµ°å°å·ï¼Œæ•°æ—¥åä»–é€æ¥äº†ä¸€å°æ„Ÿè°¢ä¿¡å’Œä¸€äº›ç¨€æœ‰ç‰©å“ä½œä¸ºå›æŠ¥ã€‚");
                            
                            // Add a random rare item
                            const allItems = [].concat(...Object.values(storeItems));
                            const rareItems = allItems.filter(item => item.rarity >= 3);
                            if (rareItems.length > 0) {
                                const randomItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                
                                if (!gameState.inventory[randomItem.id]) {
                                    gameState.inventory[randomItem.id] = {
                                        ...randomItem,
                                        quantity: 1
                                    };
                                } else {
                                    gameState.inventory[randomItem.id].quantity += 1;
                                }
                            }
                            
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "å¸‚é›†æ‰©å¼ ",
                description: "å¸‚é›†è¦æ‰©å»ºï¼Œå®˜å‘˜é‚€è¯·ä½ æŠ•èµ„ã€‚",
                options: [
                    {
                        text: "æŠ•èµ„5ä¸¤é‡‘å­",
                        effect: () => {
                            if (gameState.currencies.goldIngot >= 5000) {
                                gameState.currencies.goldIngot -= 5000;
                                showNotification("ä½ æŠ•èµ„äº†å¸‚é›†æ‰©å»ºï¼Œå®˜å‘˜éå¸¸æ„Ÿè°¢ã€‚å£°æœ›+20ï¼Œä¸‹æ¬¡å¸‚é›†ä½ å°†è·å¾—ä¼˜æƒ ï¼");
                                gameState.reputation += 20;
                                
                                // Apply discount for next market cycle
                                for (let category in storeItems) {
                                    storeItems[category].forEach(item => {
                                        item.discount = 0.1; // 10% discount
                                    });
                                }
                                
                                return true;
                            } else {
                                showNotification("ä½ æ²¡æœ‰è¶³å¤Ÿçš„é‡‘å­è¿›è¡ŒæŠ•èµ„ã€‚");
                                return false;
                            }
                        }
                    },
                    {
                        text: "å©‰æ‹’æŠ•èµ„",
                        effect: () => {
                            showNotification("ä½ å©‰æ‹’äº†æŠ•èµ„é‚€è¯·ï¼Œé”™è¿‡äº†ä¸€æ¬¡å•†æœºã€‚");
                            return true;
                        }
                    }
                ]
            },
            {
                name: "è¡Œå•†è”ç›Ÿ",
                description: "ä¸€ç¾¤è¡Œå•†é‚€è¯·ä½ åŠ å…¥ä»–ä»¬çš„è”ç›Ÿï¼Œå…±äº«èµ„æºå’Œä¿¡æ¯ã€‚",
                options: [
                    {
                        text: "åŠ å…¥è”ç›Ÿ",
                        effect: () => {
                            showNotification("ä½ åŠ å…¥äº†è¡Œå•†è”ç›Ÿï¼Œè·å¾—äº†å¸‚åœºæƒ…æŠ¥ã€‚å£°æœ›+10ï¼Œç°åœ¨ä½ å¯ä»¥æ›´å¥½åœ°é¢„æµ‹ä»·æ ¼æ³¢åŠ¨ï¼");
                            gameState.reputation += 10;
                            
                            // Reveal upcoming price trends
                            for (let category in storeItems) {
                                storeItems[category].forEach(item => {
                                    item.trendVisible = true;
                                });
                            }
                            
                            return true;
                        }
                    },
                    {
                        text: "ä¿æŒç‹¬ç«‹",
                        effect: () => {
                            showNotification("ä½ é€‰æ‹©ä¿æŒç‹¬ç«‹ç»è¥ï¼Œè·å¾—äº†ä¸€äº›è¡Œå•†çš„å°Šé‡å’Œä¸€ç¬”ç¤¼ç‰©ã€‚");
                            gameState.currencies.goldNote += 10000;
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "å¸‚åœºå±æœº",
                description: "å¸‚åœºé™·å…¥å±æœºï¼Œè´§å¸ä»·å€¼åŠ¨è¡ï¼Œä½†ä¹Ÿæœ‰æŠ•èµ„æœºä¼šã€‚",
                options: [
                    {
                        text: "å…‘æ¢ä¸ºé‡‘é”­ä¿å€¼",
                        effect: () => {
                            // Convert other currencies to gold ingots
                            const silverIngotValue = Math.floor(gameState.currencies.silverIngot / 100);
                            const goldNoteValue = Math.floor(gameState.currencies.goldNote * 0.8);
                            const silverNoteValue = Math.floor(gameState.currencies.silverNote * 0.8 / 100);
                            
                            gameState.currencies.silverIngot = 0;
                            gameState.currencies.goldNote = 0;
                            gameState.currencies.silverNote = 0;
                            
                            const totalValue = silverIngotValue + goldNoteValue + silverNoteValue;
                            gameState.currencies.goldIngot += totalValue;
                            
                            showNotification(`ä½ å°†æ‰€æœ‰è´§å¸å…‘æ¢ä¸ºé‡‘é”­ä¿å€¼ï¼ŒæˆåŠŸé¿å¼€å¸‚åœºæ³¢åŠ¨ã€‚`);
                            return true;
                        }
                    },
                    {
                        text: "æŠ•æœºå¸‚åœºæ³¢åŠ¨",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.4) {
                                // Success
                                const bonus = Math.floor((gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100) * 0.5);
                                showNotification(`ä½ æˆåŠŸé¢„æµ‹äº†å¸‚åœºæ³¢åŠ¨ï¼Œè·å¾—äº†${formatCurrency(bonus, 'é“¶')}çš„åˆ©æ¶¦ï¼`);
                                gameState.currencies.silverIngot += bonus;
                            } else {
                                // Loss
                                const loss = Math.floor((gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100) * 0.3);
                                showNotification(`ä½ çš„æŠ•èµ„å¤±è´¥äº†ï¼ŒæŸå¤±äº†${formatCurrency(loss, 'é“¶')}ã€‚`);
                                
                                // Distribute loss across currencies
                                const totalValue = gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100;
                                
                                gameState.currencies.goldIngot -= Math.floor(loss * (gameState.currencies.goldIngot / totalValue));
                                gameState.currencies.silverIngot -= Math.floor(loss * (gameState.currencies.silverIngot/100 / totalValue) * 100);
                                gameState.currencies.goldNote -= Math.floor(loss * (gameState.currencies.goldNote / totalValue));
                                gameState.currencies.silverNote -= Math.floor(loss * (gameState.currencies.silverNote/100 / totalValue) * 100);
                                
                                // Ensure no negative values
                                for (let currency in gameState.currencies) {
                                    if (gameState.currencies[currency] < 0) {
                                        gameState.currencies[currency] = 0;
                                    }
                                }
                            }
                            return true;
                        }
                    }
                ]
            }
        ];

        // Seasons and their effects
        const seasons = [
            {
                name: "æ˜¥",
                effect: {
                    type: "items",
                    target: ["tea", "medicine", "fruit", "paper"],
                    trend: 0.1
                }
            },
            {
                name: "å¤",
                effect: {
                    type: "items",
                    target: ["spice", "candies", "wine", "silk"],
                    trend: 0.1
                }
            },
            {
                name: "ç§‹",
                effect: {
                    type: "items",
                    target: ["fruit", "luxury_food", "bronze_vessel", "calligraphy"],
                    trend: 0.1
                }
            },
            {
                name: "å†¬",
                effect: {
                    type: "items",
                    target: ["jade", "gold_jewelry", "silver_jewelry", "painting"],
                    trend: 0.1
                }
            }
        ];

        // Currency display formatter
        const formatCurrency = (wenAmount, type) => {
            const ingots = Math.floor(wenAmount / 1000000);
            const taels = Math.floor((wenAmount % 1000000) / 1000);
            const wens = wenAmount % 1000;
            
            let result = '';
            
            if (ingots > 0) {
                result += `${ingots}é”­ `;
            }
            
            if (taels > 0 || ingots > 0) {
                result += `${taels}ä¸¤ `;
            }
            
            result += `${wens}æ–‡${type}`;
            
            return result;
        };

        // Update currency display
        const updateCurrencyDisplay = () => {
            const currencyDisplay = document.getElementById('currency-display');
            currencyDisplay.innerHTML = `
                <div class="currency-item gold">
                    <h3>é‡‘å­</h3>
                    <p>${formatCurrency(gameState.currencies.goldIngot, 'é‡‘')}</p>
                    <span class="currency-special">ğŸ’ ${gameState.currencyEffects.goldIngot.name}</span>
                </div>
                <div class="currency-item gold">
                    <h3>é‡‘ç¥¨</h3>
                    <p>${formatCurrency(gameState.currencies.goldNote, 'é‡‘ç¥¨')}</p>
                    <span class="currency-special">ğŸ“ˆ ${gameState.currencyEffects.goldNote.name}</span>
                </div>
                <div class="currency-item silver">
                    <h3>é“¶å­</h3>
                    <p>${formatCurrency(gameState.currencies.silverIngot, 'é“¶')}</p>
                    <span class="currency-special">ğŸ”„ ${gameState.currencyEffects.silverIngot.name}</span>
                </div>
                <div class="currency-item silver">
                    <h3>é“¶ç¥¨</h3>
                    <p>${formatCurrency(gameState.currencies.silverNote, 'é“¶ç¥¨')}</p>
                    <span class="currency-special">ğŸ” ${gameState.currencyEffects.silverNote.name}</span>
                </div>
            `;
            
            // Update stats display
            document.getElementById('business-level').textContent = gameState.businessLevel;
            document.getElementById('reputation').textContent = gameState.reputation;
            document.getElementById('game-date').textContent = `ç¬¬${gameState.date.year}å¹´ ${seasons[gameState.date.season].name}`;
            document.getElementById('level-progress').style.width = `${gameState.levelProgress}%`;
        };

        // Currency conversion options
        const setupCurrencySection = () => {
            const currencySection = document.getElementById('currency-section').querySelector('.section-content');
            
            // Calculate max tael that can be exchanged
            const maxGoldIngotTael = Math.floor(gameState.currencies.goldIngot / 1000);
            const maxGoldNoteTael = Math.floor(gameState.currencies.goldNote / 1000);
            const maxSilverIngotTael = Math.floor(gameState.currencies.silverIngot / 1000);
            const maxSilverNoteTael = Math.floor(gameState.currencies.silverNote / 1000);
            
            currencySection.innerHTML = `
                <div class="conversion-option">
                    <h3>å…‘æ¢é“¶å­</h3>
                    <p>1ä¸¤é‡‘å­ = 100ä¸¤é“¶å­</p>
                    <p><small>${gameState.currencyEffects.goldIngot.effect}</small></p>
                    <div>
                        <input type="number" id="gold-to-silver-ingot" min="0" max="${maxGoldIngotTael}" value="0">
                        <button id="exchange-gold-to-silver">å…‘æ¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>å…‘æ¢é“¶ç¥¨</h3>
                    <p>1ä¸¤é‡‘ç¥¨ = 100ä¸¤é“¶ç¥¨</p>
                    <p><small>${gameState.currencyEffects.goldNote.effect}</small></p>
                    <div>
                        <input type="number" id="gold-note-to-silver-note" min="0" max="${maxGoldNoteTael}" value="0">
                        <button id="exchange-gold-note-to-silver-note">å…‘æ¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>é‡‘å­è½¬é‡‘ç¥¨</h3>
                    <p>å…‘æ¢æ‰‹ç»­è´¹ï¼š5%</p>
                    <div>
                        <input type="number" id="gold-to-gold-note" min="0" max="${maxGoldIngotTael}" value="0">
                        <button id="exchange-gold-to-gold-note">å…‘æ¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>é“¶å­è½¬é“¶ç¥¨</h3>
                    <p>å…‘æ¢æ‰‹ç»­è´¹ï¼š5%</p>
                    <p><small>${gameState.currencyEffects.silverIngot.effect}</small></p>
                    <div>
                        <input type="number" id="silver-to-silver-note" min="0" max="${maxSilverIngotTael}" value="0">
                        <button id="exchange-silver-to-silver-note">å…‘æ¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>æŸ¥çœ‹è´§å¸ç‰¹æ€§</h3>
                    <button id="view-currency-effects">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('exchange-gold-to-silver').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-to-silver-ingot').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldIngot) {
                    gameState.currencies.goldIngot -= wenAmount;
                    gameState.currencies.silverIngot += wenAmount * 100; // 1 Gold = 100 Silver
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`æˆåŠŸå…‘æ¢ ${taelAmount}ä¸¤é‡‘å­ ä¸º ${taelAmount * 100}ä¸¤é“¶å­`);
                    addExperience(taelAmount * 0.5);
                }
            });
            
            document.getElementById('exchange-gold-note-to-silver-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-note-to-silver-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldNote) {
                    gameState.currencies.goldNote -= wenAmount;
                    gameState.currencies.silverNote += wenAmount * 100; // 1 Gold note = 100 Silver notes
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`æˆåŠŸå…‘æ¢ ${taelAmount}ä¸¤é‡‘ç¥¨ ä¸º ${taelAmount * 100}ä¸¤é“¶ç¥¨`);
                    addExperience(taelAmount * 0.5);
                }
            });
            
            document.getElementById('exchange-gold-to-gold-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-to-gold-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldIngot) {
                    gameState.currencies.goldIngot -= wenAmount;
                    gameState.currencies.goldNote += Math.floor(wenAmount * 0.95); // 5% fee
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`æˆåŠŸå…‘æ¢ ${taelAmount}ä¸¤é‡‘å­ ä¸º ${Math.floor(taelAmount * 0.95)}ä¸¤é‡‘ç¥¨ï¼ˆ5%æ‰‹ç»­è´¹ï¼‰`);
                    addExperience(taelAmount * 0.3);
                }
            });
            
            document.getElementById('exchange-silver-to-silver-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('silver-to-silver-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.silverIngot) {
                    gameState.currencies.silverIngot -= wenAmount;
                    gameState.currencies.silverNote += Math.floor(wenAmount * 0.95); // 5% fee
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`æˆåŠŸå…‘æ¢ ${taelAmount}ä¸¤é“¶å­ ä¸º ${Math.floor(taelAmount * 0.95)}ä¸¤é“¶ç¥¨ï¼ˆ5%æ‰‹ç»­è´¹ï¼‰`);
                    addExperience(taelAmount * 0.2);
                }
            });
            
            document.getElementById('view-currency-effects').addEventListener('click', () => {
                let message = "è´§å¸ç‰¹æ€§ï¼š\n\n";
                for (let currency in gameState.currencyEffects) {
                    const effect = gameState.currencyEffects[currency];
                    let currencyName = "";
                    switch(currency) {
                        case 'goldIngot': currencyName = "é‡‘å­"; break;
                        case 'goldNote': currencyName = "é‡‘ç¥¨"; break;
                        case 'silverIngot': currencyName = "é“¶å­"; break;
                        case 'silverNote': currencyName = "é“¶ç¥¨"; break;
                    }
                    message += `${currencyName} - ${effect.name}ï¼š${effect.effect}ï¼Œ${effect.bonus}\n`;
                }
                showNotification(message);
            });
        };

        // Gold egg gambling mechanics
        const setupGoldEggSection = () => {
            const goldEggSection = document.getElementById('gold-egg-section').querySelector('.section-content');
            
            // Get gold note bonus from currency effect
            const goldNoteBonusMultiplier = 1.2; // 20% bonus from gold note
            
            goldEggSection.innerHTML = `
                <p>èŠ±è´¹5ä¸¤é‡‘å­ç ¸å¼€é‡‘è›‹ï¼Œæœ‰æœºä¼šè·å¾—é‡‘ç¥¨æˆ–é“¶ç¥¨ï¼</p>
                <p><small>ä½¿ç”¨é‡‘ç¥¨æŠ½å¥–å¯è·å¾—é¢å¤–å¥–åŠ±ï¼</small></p>
                <div id="gold-egg" class="pulse">ğŸ¥š</div>
                <p id="egg-result"></p>
                <div>
                    <button id="use-gold-ingot">ä½¿ç”¨é‡‘å­ (5ä¸¤)</button>
                    <button id="use-gold-note">ä½¿ç”¨é‡‘ç¥¨ (5ä¸¤)</button>
                </div>
            `;
            
            document.getElementById('use-gold-ingot').addEventListener('click', () => {
                if (gameState.currencies.goldIngot >= gameState.eggCost) {
                    gameState.currencies.goldIngot -= gameState.eggCost;
                    crackEgg(false);
                } else {
                    document.getElementById('egg-result').textContent = `é‡‘å­ä¸è¶³ï¼Œæ— æ³•ç ¸è›‹ï¼`;
                }
            });
            
            document.getElementById('use-gold-note').addEventListener('click', () => {
                if (gameState.currencies.goldNote >= gameState.eggCost) {
                    gameState.currencies.goldNote -= gameState.eggCost;
                    crackEgg(true);
                } else {
                    document.getElementById('egg-result').textContent = `é‡‘ç¥¨ä¸è¶³ï¼Œæ— æ³•ç ¸è›‹ï¼`;
                }
            });
        };
        
        // Crack egg function
        const crackEgg = (useGoldNote) => {
            // Random result
            const result = Math.random();
            let message = '';
            
            // Apply gold note bonus if applicable
            const bonusMultiplier = useGoldNote ? 1.2 : 1.0;
            
            if (result < 0.1 * bonusMultiplier) { // 10% chance to get big win (12% with gold note)
                const goldNotes = Math.floor((Math.random() * 50 + 50) * bonusMultiplier); // 50-100 tael
                const silverNotes = Math.floor((Math.random() * 1000 + 1000) * bonusMultiplier); // 1000-2000 tael
                gameState.currencies.goldNote += goldNotes * 1000; // Convert tael to wen
                gameState.currencies.silverNote += silverNotes * 1000; // Convert tael to wen
                message = `æ­å–œï¼è·å¾—äº†${goldNotes}ä¸¤é‡‘ç¥¨å’Œ${silverNotes}ä¸¤é“¶ç¥¨ï¼`;
                addExperience(50);
            } else if (result < 0.3 * bonusMultiplier) { // 20% chance to get medium win (24% with gold note)
                const goldNotes = Math.floor((Math.random() * 30 + 20) * bonusMultiplier); // 20-50 tael
                gameState.currencies.goldNote += goldNotes * 1000; // Convert tael to wen
                message = `ä¸é”™ï¼è·å¾—äº†${goldNotes}ä¸¤é‡‘ç¥¨ï¼`;
                addExperience(20);
            } else if (result < 0.6 * bonusMultiplier) { // 30% chance to get small win (36% with gold note)
                const silverNotes = Math.floor((Math.random() * 500 + 100) * bonusMultiplier); // 100-600 tael
                gameState.currencies.silverNote += silverNotes * 1000; // Convert tael to wen
                message = `è·å¾—äº†${silverNotes}ä¸¤é“¶ç¥¨ï¼`;
                addExperience(10);
            } else { // chance to lose
                if (useGoldNote && Math.random() < 0.3) {
                    // Consolation prize when using gold note
                    const silverNotes = Math.floor(Math.random() * 100 + 50); // 50-150 tael
                    gameState.currencies.silverNote += silverNotes * 1000;
                    message = `è¿æ°”ä¸ä½³ï¼Œä½†ç”±äºä½¿ç”¨é‡‘ç¥¨ï¼Œè·å¾—äº†${silverNotes}ä¸¤é“¶ç¥¨ä½œä¸ºå®‰æ…°ã€‚`;
                    addExperience(5);
                } else {
                    message = `å¾ˆé—æ†¾ï¼Œè¿™ä¸ªè›‹æ˜¯ç©ºçš„ï¼`;
                    addExperience(2);
                }
            }
            
            document.getElementById('egg-result').textContent = message;
            updateCurrencyDisplay();
            setupCurrencySection(); // Update max values
        };

        // Setup store tabs
        const setupStoreTabs = () => {
            document.getElementById('gold-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'gold';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('gold-store-tab').classList.add('active');
            });
            
            document.getElementById('silver-ingot-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'silverIngot';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('silver-ingot-store-tab').classList.add('active');
            });
            
            document.getElementById('silver-note-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'silverNote';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('silver-note-store-tab').classList.add('active');
            });
            
            // Set initial active tab
            document.getElementById('gold-store-tab').classList.add('active');
        };

        // Update store display
        const updateStoreDisplay = () => {
            const storeContent = document.getElementById('store-content');
            storeContent.innerHTML = '';
            
            const items = storeItems[gameState.activeStore];
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('store-item');
                
                let currencySymbol = '';
                let currencyName = '';
                
                switch(item.currency) {
                    case 'goldIngot':
                        currencySymbol = 'é‡‘';
                        currencyName = 'é‡‘å­';
                        break;
                    case 'goldNote':
                        currencySymbol = 'é‡‘ç¥¨';
                        currencyName = 'é‡‘ç¥¨';
                        break;
                    case 'silverIngot':
                        currencySymbol = 'é“¶';
                        currencyName = 'é“¶å­';
                        break;
                    case 'silverNote':
                        currencySymbol = 'é“¶ç¥¨';
                        currencyName = 'é“¶ç¥¨';
                        break;
                }
                
                // Format prices for display
                const displayPrice = formatCurrency(item.price, currencySymbol);
                const displayResalePrice = formatCurrency(item.resalePrice, currencySymbol);
                
                // Price trend indicator
                let trendClass = '';
                let trendSymbol = '';
                if (item.trend > 0.1) {
                    trendClass = 'price-up';
                    trendSymbol = 'â†‘';
                } else if (item.trend < -0.1) {
                    trendClass = 'price-down';
                    trendSymbol = 'â†“';
                } else {
                    trendClass = 'price-stable';
                    trendSymbol = 'â†’';
                }
                
                // Show trend prediction if available
                let trendPrediction = '';
                if (item.trendVisible && Math.abs(item.trend) > 0.05) {
                    trendPrediction = `<p><small>é¢„æµ‹ï¼šä»·æ ¼å°†${item.trend > 0 ? 'ä¸Šæ¶¨' : 'ä¸‹è·Œ'}</small></p>`;
                }
                
                // Rarity stars
                let rarityStars = '';
                for (let i = 0; i < item.rarity; i++) {
                    rarityStars += 'â­';
                }
                
                itemElement.innerHTML = `
                    <div class="price-trend ${trendClass}">${trendSymbol}</div>
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-details">
                        <h3>${item.name} ${rarityStars}</h3>
                        <p>è´­ä¹°ä»·ï¼š${displayPrice}</p>
                        <p>å‡ºå”®ä»·ï¼š${displayResalePrice}</p>
                        ${trendPrediction}
                    </div>
                    <div class="item-actions">
                        <button class="buy-btn" data-id="${item.id}">è´­ä¹°</button>
                    </div>
                `;
                
                storeContent.appendChild(itemElement);
                
                // Add event listener for buy button
                itemElement.querySelector('.buy-btn').addEventListener('click', () => {
                    buyItem(item);
                });
            });
        };

        // Buy item function
        const buyItem = (item) => {
            const currencyBonus = item.currency === 'goldIngot' ? 0.1 : 0; // 10% more purchasing power with gold ingots
            const effectivePrice = Math.floor(item.price * (1 - currencyBonus));
            
            if (gameState.currencies[item.currency] >= effectivePrice) {
                gameState.currencies[item.currency] -= effectivePrice;
                
                // Add to inventory
                if (!gameState.inventory[item.id]) {
                    gameState.inventory[item.id] = {
                        ...item,
                        quantity: 1,
                        purchasePrice: item.price // Store purchase price for profit calculations
                    };
                } else {
                    gameState.inventory[item.id].quantity += 1;
                    // Update average purchase price
                    gameState.inventory[item.id].purchasePrice = Math.floor(
                        (gameState.inventory[item.id].purchasePrice * (gameState.inventory[item.id].quantity - 1) + item.price) / 
                        gameState.inventory[item.id].quantity
                    );
                }
                
                updateCurrencyDisplay();
                updateInventoryDisplay();
                
                // Apply gold ingot bonus message if applicable
                let bonusMessage = currencyBonus > 0 ? `ï¼ˆäº«å—é‡‘å­${currencyBonus * 100}%è´­ä¹°åŠ›åŠ æˆï¼‰` : '';
                showNotification(`æˆåŠŸè´­ä¹° ${item.name} ${bonusMessage}`);
                
                // Add experience based on rarity
                addExperience(item.rarity * 5);
            } else {
                const currencyName = item.currency === 'goldIngot' ? 'é‡‘å­' : 
                                   item.currency === 'goldNote' ? 'é‡‘ç¥¨' : 
                                   item.currency === 'silverIngot' ? 'é“¶å­' : 'é“¶ç¥¨';
                showNotification(`${currencyName}ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ï¼`);
            }
        };

        // Sell item function
        const sellItem = (item) => {
            if (gameState.inventory[item.id] && gameState.inventory[item.id].quantity > 0) {
                gameState.inventory[item.id].quantity -= 1;
                
                // Calculate profit
                const purchasePrice = gameState.inventory[item.id].purchasePrice || item.price;
                const profit = item.resalePrice - purchasePrice;
                
                // Apply silver ingot bonus for faster trading
                const silverIngotBonus = 0.15; // 15% faster trading from silver ingot effect
                let bonusExperience = Math.max(1, Math.floor(item.rarity * 2 * (1 + silverIngotBonus)));
                
                // Add currency from sale
                if (item.currency === 'goldIngot') {
                    gameState.currencies.goldIngot += item.resalePrice;
                } else if (item.currency === 'goldNote') {
                    gameState.currencies.goldNote += item.resalePrice;
                } else if (item.currency === 'silverIngot') {
                    gameState.currencies.silverIngot += item.resalePrice;
                } else {
                    gameState.currencies.silverNote += item.resalePrice;
                }
                
                // Remove from inventory if quantity is 0
                if (gameState.inventory[item.id].quantity === 0) {
                    delete gameState.inventory[item.id];
                }
                
                updateCurrencyDisplay();
                updateInventoryDisplay();
                
                let profitMessage = profit > 0 ? 
                    `ï¼Œè·åˆ©${formatCurrency(profit, item.currency === 'goldIngot' || item.currency === 'goldNote' ? 'é‡‘' : 'é“¶')}ï¼` : 
                    (profit < 0 ? `ï¼ŒäºæŸ${formatCurrency(Math.abs(profit), item.currency === 'goldIngot' || item.currency === 'goldNote' ? 'é‡‘' : 'é“¶')}ã€‚` : '');
                    
                showNotification(`æˆåŠŸå‡ºå”® ${item.name}${profitMessage}`);
                
                // Add experience based on rarity and profit
                addExperience(bonusExperience + (profit > 0 ? Math.floor(profit / 1000) : 0));
            }
        };

        // Update inventory display
        const updateInventoryDisplay = () => {
            const inventorySection = document.getElementById('inventory-section');
            inventorySection.innerHTML = '<h2 id="inventory-title">åº“å­˜</h2>';
            
            if (Object.keys(gameState.inventory).length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'æš‚æ— ç‰©å“ï¼Œå¿«å»è´­ç‰©å§ï¼';
                inventorySection.appendChild(emptyMessage);
                return;
            }
            
            for (const itemId in gameState.inventory) {
                const item = gameState.inventory[itemId];
                const itemElement = document.createElement('div');
                itemElement.classList.add('inventory-item');
                
                let currencySymbol = '';
                if (item.currency === 'goldIngot' || item.currency === 'goldNote') {
                    currencySymbol = 'é‡‘';
                } else {
                    currencySymbol = 'é“¶';
                }
                
                // Calculate potential profit/loss
                const purchasePrice = item.purchasePrice || item.price;
                const potentialProfit = item.resalePrice - purchasePrice;
                let profitColor = potentialProfit > 0 ? 'green' : (potentialProfit < 0 ? 'red' : 'black');
                let profitSymbol = potentialProfit > 0 ? 'â†‘' : (potentialProfit < 0 ? 'â†“' : 'â†’');
                
                // Rarity stars
                let rarityStars = '';
                for (let i = 0; i < item.rarity; i++) {
                    rarityStars += 'â­';
                }
                
                itemElement.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-details">
                        <h3>${item.name} ${rarityStars}</h3>
                        <p>æ•°é‡ï¼š${item.quantity}</p>
                        <p>è´­å…¥ä»·ï¼š${formatCurrency(purchasePrice, currencySymbol)}</p>
                        <p>å‡ºå”®ä»·ï¼š${formatCurrency(item.resalePrice, currencySymbol)}</p>
                        <p style="color:${profitColor}">é¢„è®¡${potentialProfit >= 0 ? 'åˆ©æ¶¦' : 'äºæŸ'}ï¼š${formatCurrency(Math.abs(potentialProfit), currencySymbol)} ${profitSymbol}</p>
                    </div>
                    <div class="item-actions">
                        <button class="sell-btn" data-id="${item.id}">å‡ºå”®</button>
                    </div>
                `;
                
                inventorySection.appendChild(itemElement);
                
                // Add event listener for sell button
                itemElement.querySelector('.sell-btn').addEventListener('click', () => {
                    sellItem(item);
                });
            }
        };

        // Add experience and handle level up
        const addExperience = (amount) => {
            gameState.levelProgress += amount;
            
            // Check for level up
            if (gameState.levelProgress >= 100) {
                gameState.businessLevel += 1;
                gameState.levelProgress = gameState.levelProgress - 100;
                
                // Level up rewards
                const rewards = {
                    goldIngot: 10 * gameState.businessLevel * 1000, // 10 tael per level
                    silverIngot: 50 * gameState.businessLevel * 1000, // 50 tael per level
                    reputation: 5 * gameState.businessLevel
                };
                
                gameState.currencies.goldIngot += rewards.goldIngot;
                gameState.currencies.silverIngot += rewards.silverIngot;
                gameState.reputation += rewards.reputation;
                
                showNotification(`æ­å–œï¼ä½ çš„å•†ä¸šç­‰çº§æå‡åˆ°${gameState.businessLevel}çº§ï¼è·å¾—å¥–åŠ±ï¼š${formatCurrency(rewards.goldIngot, 'é‡‘')}ï¼Œ${formatCurrency(rewards.silverIngot, 'é“¶')}ï¼Œå£°æœ›+${rewards.reputation}`);
                
                // Update store with new items at higher levels
                if (gameState.businessLevel === 3) {
                    storeItems.gold.push(
                        { id: 'royal_artifact', name: 'çš‡å®¶æ–‡ç‰©', icon: 'ğŸ‘‘', price: 500 * 1000, basePrice: 500 * 1000, currency: 'goldIngot', resalePrice: 450 * 1000, volatility: 0.3, trend: 0, rarity: 5 }
                    );
                    showNotification("æ–°å•†å“è§£é”ï¼šçš‡å®¶æ–‡ç‰©ï¼");
                } else if (gameState.businessLevel === 5) {
                    storeItems.silverIngot.push(
                        { id: 'ancient_treasure', name: 'å¤ä»£å®è—', icon: 'ğŸ†', price: 2000 * 1000, basePrice: 2000 * 1000, currency: 'silverIngot', resalePrice: 1800 * 1000, volatility: 0.4, trend: 0, rarity: 5 }
                    );
                    showNotification("æ–°å•†å“è§£é”ï¼šå¤ä»£å®è—ï¼");
                }
            }
            
            // Update display
            updateCurrencyDisplay();
        };

        // Show notification
        const showNotification = (message) => {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.textContent = message;
            
            const mainElement = document.querySelector('main');
            mainElement.insertBefore(notification, mainElement.firstChild);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        };

        // Show event notification with options
        const showEventNotification = (event) => {
            const eventContainer = document.getElementById('event-container');
            const eventElement = document.createElement('div');
            eventElement.classList.add('event-notification');
            
            let optionsHTML = '';
            event.options.forEach((option, index) => {
                optionsHTML += `<button class="event-option" data-option="${index}">${option.text}</button>`;
            });
            
            eventElement.innerHTML = `
                <h3>${event.name}</h3>
                <p>${event.description}</p>
                <div class="event-options">
                    ${optionsHTML}
                </div>
            `;
            
            eventContainer.appendChild(eventElement);
            
            // Add event listeners
            eventElement.querySelectorAll('.event-option').forEach((button, index) => {
                button.addEventListener('click', () => {
                    const success = event.options[index].effect();
                    
                    if (success) {
                        // Remove the event notification
                        eventElement.style.opacity = '0';
                        eventElement.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (eventElement.parentNode) {
                                eventElement.parentNode.removeChild(eventElement);
                            }
                        }, 500);
                    }
                    
                    updateCurrencyDisplay();
                    updateStoreDisplay();
                    updateInventoryDisplay();
                });
            });
        };

        // Generate a random event
        const generateRandomEvent = () => {
            if (Math.random() < 0.3) { // 30% chance for an event
                const randomEvent = gameEvents[Math.floor(Math.random() * gameEvents.length)];
                showEventNotification(randomEvent);
            }
        };

        // Update market with random price fluctuations
        const updateMarket = () => {
            let newsContent = '';
            
            // Apply seasonal effects
            const season = seasons[gameState.date.season];
            newsContent = `${gameState.date.year}å¹´${season.name}å­£ï¼š`;
            
            // Apply seasonal item effects
            if (season.effect.type === 'items') {
                season.effect.target.forEach(itemId => {
                    // Find the item in all stores
                    for (let category in storeItems) {
                        const item = storeItems[category].find(i => i.id === itemId);
                        if (item) {
                            item.trend += season.effect.trend;
                        }
                    }
                });
                
                newsContent += `${season.name}å­£èŠ‚æ€§å•†å“éœ€æ±‚å¢åŠ ã€‚`;
            }
            
            // Apply active events effects
            gameState.events = gameState.events.filter(event => event.duration > 0);
            
            if (gameState.events.length > 0) {
                newsContent += ' ';
                gameState.events.forEach(event => {
                    newsContent += `${event.name}ï¼š${event.description} `;
                    
                    // Apply event effects
                    if (event.effect.type === 'global') {
                        // Apply to all items
                        for (let category in storeItems) {
                            storeItems[category].forEach(item => {
                                item.volatility = Math.max(0.05, item.volatility + event.effect.volatility);
                                item.trend += event.effect.trend;
                            });
                        }
                    } else if (event.effect.type === 'category') {
                        // Apply to specific category
                        if (storeItems[event.effect.target]) {
                            storeItems[event.effect.target].forEach(item => {
                                item.volatility = Math.max(0.05, item.volatility + event.effect.volatility);
                                item.trend += event.effect.trend;
                            });
                        }
                    } else if (event.effect.type === 'items') {
                        // Apply to specific items
                        event.effect.target.forEach(itemId => {
                            // Find the item in all stores
                            for (let category in storeItems) {
                                const item = storeItems[category].find(i => i.id === itemId);
                                if (item) {
                                    item.trend += event.effect.trend;
                                }
                            }
                        });
                    } else if (event.effect.type === 'currency') {
                        // Apply to currency
                        // Effect will be applied during transactions
                    }
                    
                    // Decrease duration
                    event.duration--;
                });
            } else {
                newsContent += 'å¸‚åœºå¹³ç¨³ã€‚';
            }
            
            // Update all prices based on trend and volatility
            for (let category in storeItems) {
                storeItems[category].forEach(item => {
                    // Base fluctuation based on volatility
                    const fluctuation = (Math.random() * 2 - 1) * item.volatility;
                    
                    // Add trend component
                    const trendComponent = item.trend;
                    
                    // Silver note market info bonus - reduce randomness
                    const marketInfoBonus = category === 'silverNote' ? 0.25 : 0; // 25% better market info
                    
                    // Calculate total price change
                    const totalChange = fluctuation * (1 - marketInfoBonus) + trendComponent;
                    
                    // Update price
                    item.price = Math.max(
                        Math.floor(item.price * (1 + totalChange)),
                        Math.floor(item.basePrice * 0.5) // Price won't go below 50% of base
                    );
                    
                    // Update resale price (except for notes)
                    if (item.currency !== 'goldNote' && item.currency !== 'silverNote') {
                        item.resalePrice = Math.max(
                            Math.floor(item.price * 0.8),
                            Math.floor(item.basePrice * 0.4) // Resale won't go below 40% of base
                        );
                    }
                    
                    // Gradually reset trend toward zero for next cycle
                    item.trend = item.trend * 0.8;
                });
            }
            
            // Update market news
            document.getElementById('market-news-content').textContent = newsContent;
            
            // Update displays
            updateStoreDisplay();
            updateInventoryDisplay();
            
            // Small chance for random event
            generateRandomEvent();
        };

        // Advance game time
        const advanceTime = () => {
            // Advance season
            gameState.date.season = (gameState.date.season + 1) % 4;
            
            // If we completed a year, advance the year
            if (gameState.date.season === 0) {
                gameState.date.year += 1;
            }
            
            // Random market event
            if (Math.random() < 0.3) { // 30% chance for a market event
                const randomEvent = marketEvents[Math.floor(Math.random() * marketEvents.length)];
                gameState.events.push({...randomEvent}); // Clone the event
                showNotification(`å¸‚åœºäº‹ä»¶ï¼š${randomEvent.name} - ${randomEvent.description}`);
            }
            
            // Update market
            updateMarket();
            
            // Update display
            updateCurrencyDisplay();
        };

        // Toggle section collapse
        const toggleSection = (sectionId) => {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.section-content');
            const toggle = section.querySelector('.section-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                gameState.sectionCollapsed[sectionId.replace('-section', '')] = false;
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                gameState.sectionCollapsed[sectionId.replace('-section', '')] = true;
            }
        };

        // Initialize game
        const initGame = () => {
            updateCurrencyDisplay();
            setupCurrencySection();
            setupGoldEggSection();
            setupStoreTabs();
            updateStoreDisplay();
            updateInventoryDisplay();
            
            // Initialize section collapse state
            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const sectionId = toggle.closest('section').id;
                    toggleSection(sectionId);
                });
                
                // Set initial state
                const sectionId = toggle.closest('section').id;
                const sectionKey = sectionId.replace('-section', '');
                if (gameState.sectionCollapsed[sectionKey]) {
                    const content = document.getElementById(sectionId).querySelector('.section-content');
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                }
            });
            
            // Start game timer - advances time every 60 seconds
            setInterval(advanceTime, 60000);
            
            // Welcome message
            showNotification("æ¬¢è¿æ¥åˆ°å¤©ä¹¦å°æ‘Šï¼è¯·å¼€å§‹ä½ çš„å•†ä¸šå†’é™©ï¼");
        };

        // Start the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
