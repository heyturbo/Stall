<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§©‰π¶Â∞èÊëä - ÁªèÂïÜÊ®°ÊãüÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            font-size: 14px;
        }

        #game-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #8B4513;
            margin-bottom: 5px;
            font-size: 1.8em;
        }

        h2 {
            color: #8B4513;
            margin-bottom: 8px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
        }

        h3 {
            font-size: 1.1em;
        }

        .section-toggle {
            cursor: pointer;
            margin-right: 8px;
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        #currency-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .currency-item {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            background-color: #f9f9f9;
            position: relative;
            overflow: hidden;
            font-size: 0.9em;
        }

        .currency-item h3 {
            font-size: 1em;
            margin-bottom: 3px;
        }

        .currency-item p {
            position: relative;
            z-index: 2;
            font-size: 0.9em;
        }

        .currency-special {
            position: absolute;
            bottom: 3px;
            right: 3px;
            font-size: 0.7em;
            opacity: 0.7;
            z-index: 1;
        }

        .gold {
            background-color: #FFEB99;
        }

        .silver {
            background-color: #E0E0E0;
        }

        section {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .section-content {
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .tab-container {
            margin-top: 15px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }

        .tab-button {
            flex: 1;
            padding: 8px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .tab-button:hover {
            background-color: #e0e0e0;
        }

        .tab-button.active {
            background-color: #8B4513;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .store-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            position: relative;
            overflow: hidden;
            font-size: 0.9em;
        }

        .price-trend {
            position: absolute;
            top: 0;
            right: 0;
            padding: 3px;
            font-size: 0.7em;
            color: white;
            border-bottom-left-radius: 5px;
        }

        .price-up {
            background-color: #4CAF50;
        }

        .price-down {
            background-color: #F44336;
        }

        .price-stable {
            background-color: #9E9E9E;
        }

        .item-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .item-details {
            flex: 1;
            font-size: 0.9em;
        }

        .item-price {
            margin-left: 10px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .item-actions {
            margin-left: 10px;
        }

        button {
            padding: 5px 10px;
            background-color: #8B4513;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }

        button:hover {
            background-color: #a0522d;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #gold-egg-section {
            text-align: center;
        }

        #gold-egg {
            font-size: 3em;
            cursor: pointer;
            transition: transform 0.3s;
            display: inline-block;
        }

        #gold-egg:hover {
            transform: scale(1.1);
        }

        .inventory-item {
            margin: 5px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            font-size: 0.9em;
        }

        .conversion-option {
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            font-size: 0.9em;
        }

        .conversion-option input {
            width: 70px;
            padding: 3px;
            margin-right: 5px;
        }

        footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.8em;
        }

        .notification {
            padding: 8px;
            margin: 8px 0;
            border-radius: 5px;
            background-color: #f8f8f8;
            border-left: 4px solid #8B4513;
            font-size: 0.9em;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .market-news {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            font-size: 0.9em;
        }

        .market-news h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 3px;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .event-notification {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #FFF8E1;
            border-left: 4px solid #FFC107;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.9em;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #8B4513;
            width: 0%;
            transition: width 0.3s;
        }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .stat-item {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            background-color: #f0f0f0;
            font-size: 0.8em;
        }

        .stat-item h4 {
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1s infinite;
        }

        .timer-display {
            text-align: center;
            margin: 5px 0;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #8B4513;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        #quick-actions {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 10px;
            display: none;
            z-index: 999;
        }

        #quick-actions.visible {
            display: block;
        }

        .quick-action-button {
            display: block;
            width: 100%;
            text-align: left;
            margin-bottom: 5px;
            padding: 8px;
        }

        .badge {
            display: inline-block;
            padding: 2px 5px;
            background-color: #FF5722;
            color: white;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 5px;
            font-weight: bold;
        }

        .alert {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid transparent;
            font-weight: bold;
            text-align: center;
        }

        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-warning {
            color: #856404;
            background-color: #fff3cd;
            border-color: #ffeeba;
        }

        .flash {
            animation: flash 0.5s ease-in-out;
        }

        @keyframes flash {
            0% { background-color: transparent; }
            50% { background-color: rgba(255, 255, 0, 0.5); }
            100% { background-color: transparent; }
        }

        /* Mobile-specific styles */
        @media (max-width: 700px) {
            body {
                font-size: 12px;
            }
            
            #game-container {
                padding: 5px;
            }
            
            .store-item, .inventory-item, .currency-item {
                padding: 5px;
            }
            
            .item-icon {
                font-size: 1.2em;
                margin-right: 5px;
            }
            
            button {
                padding: 4px 8px;
                font-size: 0.85em;
            }
            
            #gold-egg {
                font-size: 2.5em;
            }
            
            .stats-display {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .conversion-option {
                padding: 8px;
            }
            
            .conversion-option input {
                width: 60px;
            }
        }

        /* Mini market feature */
        .mini-market {
            margin-top: 10px;
            padding: 8px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .mini-market-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: white;
            border-radius: 3px;
            font-size: 0.85em;
        }

        /* Achievements system */
        .achievement {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 3px solid #8B4513;
        }

        .achievement-icon {
            margin-right: 10px;
            font-size: 1.3em;
        }

        .achievement-locked {
            opacity: 0.5;
        }

        /* Loan system */
        .loan-option {
            padding: 8px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .loan-active {
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <!-- Game container -->
    <div id="game-container">
        <!-- Header -->
        <header>
            <h1>Â§©‰π¶Â∞èÊëä</h1>
            <div class="timer-display">
                <span id="market-timer">Â∏ÇÂú∫Êõ¥Êñ∞Ôºö15s</span>
            </div>
            <div id="currency-display">
                <!-- Currency information will go here -->
            </div>
            <!-- Stats display -->
            <div class="stats-display">
                <div class="stat-item">
                    <h4>ÂïÜ‰∏öÁ≠âÁ∫ß</h4>
                    <p id="business-level">1</p>
                </div>
                <div class="stat-item">
                    <h4>Â£∞Êúõ</h4>
                    <p id="reputation">0</p>
                </div>
                <div class="stat-item">
                    <h4>Êó•Êúü</h4>
                    <p id="game-date">Á¨¨1Âπ¥ Êò•</p>
                </div>
            </div>
            <div class="progress-bar-container">
                <div id="level-progress" class="progress-bar" style="width: 0%"></div>
            </div>
        </header>
        
        <!-- Main game area -->
        <main>
            <!-- Market news -->
            <section id="news-section">
                <h2><span class="section-toggle">üì∞</span>Â∏ÇÂú∫Âä®ÊÄÅ</h2>
                <div class="section-content">
                    <div class="market-news">
                        <h3>ÊúÄÊñ∞Ê∂àÊÅØ</h3>
                        <p id="market-news-content">Ê¨¢ËøéÊù•Âà∞Â§©‰π¶Â∞èÊëäÔºÅÂ∏ÇÂú∫Á®≥ÂÆöÔºåÂêÑÁ±ªÂïÜÂìÅ‰ª∑Ê†ºÊ≠£Â∏∏„ÄÇ</p>
                    </div>
                    <div id="event-container">
                        <!-- Random events will go here -->
                    </div>
                </div>
            </section>
            
            <!-- Currency section -->
            <section id="currency-section">
                <h2><span class="section-toggle">üí∞</span>Èí±Â∫Ñ</h2>
                <div class="section-content collapsed">
                    <!-- Currency conversion options -->
                </div>
            </section>
            
            <!-- Gold egg gambling section -->
            <section id="gold-egg-section">
                <h2><span class="section-toggle">ü•ö</span>ÈáëËõãÊäΩÂ•ñ</h2>
                <div class="section-content collapsed">
                    <!-- Gold egg gambling mechanics -->
                </div>
            </section>
            
            <!-- Tab Container for Stores/Inventory -->
            <section id="main-section">
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="store-tab">ÂïÜÂ∫ó</button>
                        <button class="tab-button" data-tab="inventory-tab">Â∫ìÂ≠ò</button>
                        <button class="tab-button" data-tab="features-tab">ÁâπËâ≤</button>
                    </div>
                    
                    <!-- Store Tab -->
                    <div id="store-tab" class="tab-content active">
                        <!-- Store tabs -->
                        <div id="store-tabs">
                            <button id="gold-store-tab">ÈáëÂ∫ó</button>
                            <button id="silver-ingot-store-tab">Èì∂Èî≠Â∫ó</button>
                            <button id="silver-note-store-tab">Èì∂Á•®Â∫ó</button>
                        </div>
                        
                        <!-- Store content -->
                        <div id="store-content">
                            <!-- Store items will go here -->
                        </div>
                    </div>
                    
                    <!-- Inventory Tab -->
                    <div id="inventory-tab" class="tab-content">
                        <h3>Â∫ìÂ≠ò</h3>
                        <div id="inventory-content">
                            <!-- Player's inventory will go here -->
                        </div>
                    </div>
                    
                    <!-- Features Tab -->
                    <div id="features-tab" class="tab-content">
                        <div class="features-container">
                            <h3>ÁâπËâ≤ÂäüËÉΩ</h3>
                            
                            <!-- Mini market -->
                            <div class="feature-section">
                                <h4>Èó™ÁîµÂ∏ÇÂú∫ <span class="badge" id="mini-market-badge">Êñ∞</span></h4>
                                <p>Á®ÄÊúâÂïÜÂìÅÈôêÊó∂ÁâπÂçñÔºÅÊØèÊ¨°Â∏ÇÂú∫Êõ¥Êñ∞ÊúâÊú∫‰ºöÂà∑Êñ∞</p>
                                <div id="mini-market" class="mini-market">
                                    <!-- Mini market items will go here -->
                                </div>
                            </div>
                            
                            <!-- Loans -->
                            <div class="feature-section">
                                <h4>ÂïÜ‰∏öË¥∑Ê¨æ</h4>
                                <div id="loan-system">
                                    <!-- Loan options will go here -->
                                </div>
                            </div>
                            
                            <!-- Achievements -->
                            <div class="feature-section">
                                <h4>ÊàêÂ∞±Á≥ªÁªü</h4>
                                <div id="achievements-container">
                                    <!-- Achievements will go here -->
                                </div>
                            </div>
                            
                            <!-- Price prediction -->
                            <div class="feature-section">
                                <h4>‰ª∑Ê†ºÈ¢ÑÊµã</h4>
                                <div id="prediction-system">
                                    <select id="prediction-item">
                                        <option value="">ÈÄâÊã©ÂïÜÂìÅ</option>
                                        <!-- Items will be added here -->
                                    </select>
                                    <select id="prediction-trend">
                                        <option value="up">‰∏äÊ∂®</option>
                                        <option value="down">‰∏ãË∑å</option>
                                    </select>
                                    <input type="number" id="prediction-amount" placeholder="ÊäïÊ≥®È¢ù" min="1000">
                                    <button id="make-prediction">È¢ÑÊµã</button>
                                    <div id="prediction-results">
                                        <!-- Prediction results will go here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- Quick action floating button -->
        <div class="floating-button" id="quick-action-button">‚ö°</div>
        <div id="quick-actions">
            <button class="quick-action-button" id="quick-buy">Âø´ÈÄüË¥≠‰π∞ÁÉ≠Èó®ÂïÜÂìÅ</button>
            <button class="quick-action-button" id="quick-sell">‰∏ÄÈîÆÂá∫ÂîÆÊâÄÊúâÂïÜÂìÅ</button>
            <button class="quick-action-button" id="quick-exchange">Âø´ÈÄüË¥ßÂ∏ÅÂÖëÊç¢</button>
            <button class="quick-action-button" id="quick-egg">Âø´ÈÄüÊäΩÂ•ñ</button>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>Â§©‰π¶Â∞èÊëä - ÁªèÂïÜÊ®°ÊãüÊ∏∏Êàè</p>
        </footer>
    </div>

    <script>
        // Game state
        const gameState = {
            currencies: {
                goldIngot: 50 * 1000, // 50 tael = 50,000 wen
                goldNote: 0,
                silverIngot: 0,
                silverNote: 0
            },
            inventory: {},
            activeStore: 'gold',
            eggCost: 5 * 1000, // 5 tael = 5,000 wen
            businessLevel: 1,
            reputation: 0,
            levelProgress: 0,
            date: {
                year: 1,
                season: 0 // 0-Spring, 1-Summer, 2-Autumn, 3-Winter
            },
            marketTrends: {},
            events: [],
            timerCount: 15, // 15-second timer for market updates
            activePredictions: [],
            miniMarketItems: [],
            activeLoans: [],
            achievements: [],
            unlockedAchievements: [],
            sectionCollapsed: {
                currency: true,
                goldEgg: true,
                news: false
            },
            statistics: {
                totalPurchases: 0,
                totalSales: 0,
                totalProfit: 0,
                totalEggsOpen: 0,
                biggestProfit: 0,
                mostExpensivePurchase: 0
            },
            // Special currency effects
            currencyEffects: {
                goldIngot: {
                    name: "ÈªÑÈáëÂÇ®Â§á",
                    effect: "‰øùÂÄºÔºå‰ª∑Ê†ºÁ®≥ÂÆöÔºåÊûÅÂ∞ëË¥¨ÂÄº",
                    bonus: "Ë¥≠‰π∞Âäõ+10%"
                },
                goldNote: {
                    name: "‰ø°Ë™âÊäïËµÑ",
                    effect: "È£éÈô©Êõ¥È´òÁöÑÊäïËµÑÁ±ªË¥ßÂ∏Å",
                    bonus: "ÊäïËµÑÂõûÊä•+20%"
                },
                silverIngot: {
                    name: "ÊµÅÈÄöË¥ßÂ∏Å",
                    effect: "‰æø‰∫éÊó•Â∏∏‰∫§Êòì",
                    bonus: "‰∫§ÊòìÈÄüÂ∫¶+15%"
                },
                silverNote: {
                    name: "Â∏ÇÂú∫ÊäïÊú∫",
                    effect: "ÂèóÂ∏ÇÂú∫Ê≥¢Âä®ÂΩ±ÂìçÂ§ß",
                    bonus: "Â∏ÇÂú∫ÊÉÖÊä•+25%"
                }
            }
        };

        // Store items with price fluctuation metadata (prices in wen)
        const storeItems = {
            gold: [
                { id: 'ancient_book', name: 'Âè§Á±ç', icon: 'üìú', price: 100 * 1000, basePrice: 100 * 1000, currency: 'goldIngot', resalePrice: 80 * 1000, volatility: 0.2, trend: 0, rarity: 3 },
                { id: 'jade', name: 'ÁéâÁü≥', icon: 'üß©', price: 50 * 1000, basePrice: 50 * 1000, currency: 'goldIngot', resalePrice: 40 * 1000, volatility: 0.3, trend: 0, rarity: 2 },
                { id: 'tea', name: 'ÁèçË¥µËå∂Âè∂', icon: 'üçµ', price: 30 * 1000, basePrice: 30 * 1000, currency: 'goldIngot', resalePrice: 25 * 1000, volatility: 0.4, trend: 0, rarity: 1 },
                { id: 'painting', name: 'ÂêçÂÆ∂Â≠óÁîª', icon: 'üñºÔ∏è', price: 150 * 1000, basePrice: 150 * 1000, currency: 'goldIngot', resalePrice: 120 * 1000, volatility: 0.25, trend: 0, rarity: 4 },
                { id: 'gold_jewelry', name: 'ÈáëÈ•∞', icon: 'üíç', price: 80 * 1000, basePrice: 80 * 1000, currency: 'goldNote', resalePrice: 70 * 1000, volatility: 0.35, trend: 0, rarity: 3 },
                { id: 'silk', name: '‰∏ùÁª∏', icon: 'üß∂', price: 60 * 1000, basePrice: 60 * 1000, currency: 'goldNote', resalePrice: 50 * 1000, volatility: 0.3, trend: 0, rarity: 2 },
                { id: 'spice', name: 'Á®ÄÊúâÈ¶ôÊñô', icon: 'üå∂Ô∏è', price: 40 * 1000, basePrice: 40 * 1000, currency: 'goldNote', resalePrice: 30 * 1000, volatility: 0.45, trend: 0, rarity: 2 },
            ],
            silverIngot: [
                { id: 'bronze_vessel', name: 'ÈìúÂô®', icon: 'üè∫', price: 500 * 1000, basePrice: 500 * 1000, currency: 'silverIngot', resalePrice: 400 * 1000, volatility: 0.35, trend: 0, rarity: 3 },
                { id: 'wine', name: 'ËÄÅÈÖí', icon: 'üç∂', price: 300 * 1000, basePrice: 300 * 1000, currency: 'silverIngot', resalePrice: 250 * 1000, volatility: 0.4, trend: 0, rarity: 2 },
                { id: 'calligraphy', name: '‰π¶Ê≥ï', icon: '‚úíÔ∏è', price: 700 * 1000, basePrice: 700 * 1000, currency: 'silverIngot', resalePrice: 600 * 1000, volatility: 0.3, trend: 0, rarity: 4 },
                { id: 'medicine', name: 'ËçØÊùê', icon: 'üåø', price: 250 * 1000, basePrice: 250 * 1000, currency: 'silverIngot', resalePrice: 200 * 1000, volatility: 0.45, trend: 0, rarity: 2 },
                { id: 'silver_jewelry', name: 'Èì∂È•∞', icon: '‚ö±Ô∏è', price: 350 * 1000, basePrice: 350 * 1000, currency: 'silverIngot', resalePrice: 300 * 1000, volatility: 0.35, trend: 0, rarity: 3 },
            ],
            silverNote: [
                { id: 'fruit', name: 'Ê∞¥Êûú', icon: 'üçé', price: 50 * 1000, basePrice: 50 * 1000, currency: 'silverNote', resalePrice: 40 * 1000, volatility: 0.5, trend: 0, rarity: 1 },
                { id: 'candies', name: 'Á≥ñÊûú', icon: 'üç¨', price: 30 * 1000, basePrice: 30 * 1000, currency: 'silverNote', resalePrice: 25 * 1000, volatility: 0.45, trend: 0, rarity: 1 },
                { id: 'paper', name: 'Á∫∏Âº†', icon: 'üìÉ', price: 20 * 1000, basePrice: 20 * 1000, currency: 'silverNote', resalePrice: 15 * 1000, volatility: 0.4, trend: 0, rarity: 1 },
                { id: 'incense', name: 'È¶ô', icon: 'üß®', price: 40 * 1000, basePrice: 40 * 1000, currency: 'silverNote', resalePrice: 30 * 1000, volatility: 0.5, trend: 0, rarity: 2 },
                { id: 'luxury_food', name: 'ÁèçÈ¶êÁæéÈ£ü', icon: 'üç≤', price: 100 * 1000, basePrice: 100 * 1000, currency: 'silverNote', resalePrice: 80 * 1000, volatility: 0.55, trend: 0, rarity: 3 },
                { id: 'foreign_trinket', name: 'ÂºÇÂüüÂ∞èÁâ©', icon: 'üß∏', price: 70 * 1000, basePrice: 70 * 1000, currency: 'silverNote', resalePrice: 55 * 1000, volatility: 0.5, trend: 0, rarity: 2 },
            ]
        };

        // Rare items for mini market
        const rareItems = [
            { id: 'dragon_pearl', name: 'ÈæôÁè†', icon: 'üîÆ', price: 300 * 1000, basePrice: 300 * 1000, currency: 'goldIngot', resalePrice: 280 * 1000, volatility: 0.3, trend: 0, rarity: 5 },
            { id: 'phoenix_feather', name: 'Âá§Âá∞ÁæΩ', icon: 'ü™∂', price: 250 * 1000, basePrice: 250 * 1000, currency: 'goldIngot', resalePrice: 220 * 1000, volatility: 0.35, trend: 0, rarity: 5 },
            { id: 'immortal_herb', name: '‰ªôËçâ', icon: 'üå±', price: 500 * 1000, basePrice: 500 * 1000, currency: 'goldNote', resalePrice: 450 * 1000, volatility: 0.4, trend: 0, rarity: 5 },
            { id: 'heaven_scroll', name: 'Â§©‰π¶Âç∑ËΩ¥', icon: 'üìø', price: 1000 * 1000, basePrice: 1000 * 1000, currency: 'goldNote', resalePrice: 900 * 1000, volatility: 0.25, trend: 0, rarity: 6 },
            { id: 'divine_weapon', name: 'Á•ûÂÖµÂà©Âô®', icon: '‚öîÔ∏è', price: 2000 * 1000, basePrice: 2000 * 1000, currency: 'silverIngot', resalePrice: 1800 * 1000, volatility: 0.3, trend: 0, rarity: 6 },
            { id: 'royal_jade', name: 'ÁöáÂÆ∂ÁéâÁé∫', icon: 'üíé', price: 3000 * 1000, basePrice: 3000 * 1000, currency: 'silverIngot', resalePrice: 2700 * 1000, volatility: 0.2, trend: 0, rarity: 7 },
            { id: 'ancient_map', name: 'Âè§‰ª£Âú∞Âõæ', icon: 'üó∫Ô∏è', price: 800 * 1000, basePrice: 800 * 1000, currency: 'silverNote', resalePrice: 700 * 1000, volatility: 0.45, trend: 0, rarity: 5 },
            { id: 'magical_powder', name: '‰ªôÂ∞ò', icon: '‚ú®', price: 150 * 1000, basePrice: 150 * 1000, currency: 'silverNote', resalePrice: 130 * 1000, volatility: 0.5, trend: 0, rarity: 4 }
        ];

        // Achievements
        const achievementsList = [
            { id: 'first_sale', name: 'ÂàùÊ¨°‰∫§Êòì', description: 'Á¨¨‰∏ÄÊ¨°ÂîÆÂá∫Áâ©ÂìÅ', icon: 'üèÜ', requirement: () => gameState.statistics.totalSales >= 1, reward: 5000 },
            { id: 'big_spender', name: 'Â§ßÊâãÁ¨î', description: '‰∏ÄÊ¨°Ë¥≠‰π∞Ë∂ÖËøá100‰∏§ÈáëÂ≠êÁöÑÁâ©ÂìÅ', icon: 'üí∞', requirement: () => gameState.statistics.mostExpensivePurchase >= 100000, reward: 10000 },
            { id: 'profit_master', name: 'Âà©Ê∂¶Â§ßÂ∏à', description: 'Á¥ØËÆ°Âà©Ê∂¶Ë∂ÖËøá1000‰∏§Èì∂Â≠ê', icon: 'üìà', requirement: () => gameState.statistics.totalProfit >= 1000000, reward: 20000 },
            { id: 'lucky_egg', name: 'Âπ∏ËøêËõãÁéã', description: 'ÂºÄÂá∫10‰∏™ÈáëËõã', icon: 'ü•ö', requirement: () => gameState.statistics.totalEggsOpen >= 10, reward: 15000 },
            { id: 'business_tycoon', name: 'ÂïÜ‰∏öÂ§ß‰∫®', description: 'ËææÂà∞ÂïÜ‰∏öÁ≠âÁ∫ß5', icon: 'üëë', requirement: () => gameState.businessLevel >= 5, reward: 50000 },
            { id: 'collector', name: 'Êî∂ËóèÂÆ∂', description: 'ÂêåÊó∂Êã•Êúâ10Áßç‰∏çÂêåÁâ©ÂìÅ', icon: 'üßÆ', requirement: () => Object.keys(gameState.inventory).length >= 10, reward: 30000 },
            { id: 'market_predictor', name: 'Â∏ÇÂú∫È¢ÑË®ÄÂÆ∂', description: 'ÊàêÂäüÈ¢ÑÊµã3Ê¨°‰ª∑Ê†ºË∂ãÂäø', icon: 'üîÆ', requirement: () => gameState.statistics.successfulPredictions >= 3, reward: 25000 },
            { id: 'rare_collector', name: 'Á®ÄÊúâÊî∂ËóèÂÆ∂', description: 'Êã•Êúâ‰∏Ä‰ª∂Á®ÄÊúâÂ∫¶5+ÁöÑÁâ©ÂìÅ', icon: 'üíé', requirement: () => Object.values(gameState.inventory).some(item => item.rarity >= 5), reward: 40000 }
        ];

        // New additional market events
        const additionalMarketEvents = [
            {
                name: "ÁöáÂÆ§Â©öÁ§º",
                description: "ÁöáÂÆ∂Â©öÁ§ºÂç≥Â∞Ü‰∏æË°åÔºåÂ•¢‰æàÂìÅ‰ª∑Ê†ºÈ£ôÂçáÔºÅ",
                effect: {
                    type: "items",
                    target: ["gold_jewelry", "silver_jewelry", "jade", "silk", "luxury_food"],
                    trend: 0.5
                },
                duration: 2
            },
            {
                name: "ËæπÂ¢ÉÂÜ≤Á™Å",
                description: "ËæπÂ¢ÉÂèëÁîüÂ∞èËßÑÊ®°ÂÜ≤Á™ÅÔºåËøêËæìÂèóÈòªÔºåÂ§ñÊù•Áâ©ÂìÅ‰ª∑Ê†º‰∏äÊ∂®„ÄÇ",
                effect: {
                    type: "items",
                    target: ["foreign_trinket", "spice"],
                    trend: 0.4
                },
                duration: 1
            },
            {
                name: "Êµ∑Ë∑ØÈòªÊñ≠",
                description: "Êµ∑‰∏äÈ£éÊö¥ÈòªÊñ≠Ë¥∏ÊòìË∑ØÁ∫øÔºåÁèçÁ®ÄÂïÜÂìÅ‰ª∑Ê†ºÊö¥Ê∂®„ÄÇ",
                effect: {
                    type: "category",
                    target: "gold",
                    volatility: 0.3,
                    trend: 0.3
                },
                duration: 2
            },
            {
                name: "ÁöáÂÆ∂ÂæÅÁ®é",
                description: "ÊúùÂª∑Â§ßÂπÖÂ¢ûÂä†ÂêÑÁ±ªÁ®éÊî∂ÔºåÂ∏ÇÂú∫ÊÅêÊÖåÔºåÈáë‰ª∑ÂâßÁÉàÊ≥¢Âä®„ÄÇ",
                effect: {
                    type: "currency",
                    target: "goldIngot",
                    multiplier: 0.9
                },
                duration: 2
            },
            {
                name: "Â∏ÇÂú∫Â¥©Áõò",
                description: "Â∏ÇÂú∫‰ø°ÂøÉÂ¥©Ê∫ÉÔºåÈì∂Á•®‰ª∑ÂÄºÊö¥Ë∑åÔºå‰∫∫‰ª¨‰∫âÁõ∏Âõ§ÁßØÂÆûÁâ©ËµÑ‰∫ß„ÄÇ",
                effect: {
                    type: "currency",
                    target: "silverNote",
                    multiplier: 0.5
                },
                duration: 1
            },
            {
                name: "ÈáëÁüøÂèëÁé∞",
                description: "ÈôÑËøëÂèëÁé∞ÈáëÁüøÔºåÈáë‰ª∑‰∏ãË∑åÔºåÂ∑•ÂÖ∑Á±ªÁâ©ÂìÅÈúÄÊ±ÇÂ¢ûÂä†„ÄÇ",
                effect: {
                    type: "currency",
                    target: "goldIngot",
                    multiplier: 0.7
                },
                duration: 3
            },
            {
                name: "Â§©ÁÅæÈ£éÊö¥",
                description: "ÁâπÂ§ßÈ£éÊö¥Ë¢≠ÂáªÊ≤øÊµ∑Âú∞Âå∫ÔºåÁâ©ËµÑÁü≠Áº∫Ôºå‰ª∑Ê†ºÊôÆÈÅç‰∏äÊ∂®„ÄÇ",
                effect: {
                    type: "global",
                    volatility: 0.5,
                    trend: 0.4
                },
                duration: 1
            },
            {
                name: "ÁòüÁñ´ÁàÜÂèë",
                description: "Âüé‰∏≠ÁàÜÂèëÁòüÁñ´ÔºåÂåªËçØÈúÄÊ±ÇÊö¥Â¢ûÔºåÂÖ∂‰ªñÁâ©ÂìÅÊªûÈîÄ„ÄÇ",
                effect: {
                    type: "items",
                    target: ["medicine", "tea"],
                    trend: 0.8
                },
                duration: 2
            },
            {
                name: "Â∏ÇÂú∫ÁãÇÁÉ≠",
                description: "‰∏çÊòéÂéüÂõ†ÁöÑÂ∏ÇÂú∫ÁãÇÁÉ≠Ôºå‰∫∫‰ª¨ÁñØÁãÇË¥≠‰π∞ÂêÑÁ±ªÁâ©ÂìÅ„ÄÇ",
                effect: {
                    type: "global",
                    volatility: 0.7,
                    trend: 0.3
                },
                duration: 1
            }
        ];

        // Combine original market events with additional ones
        const marketEvents = [
            {
                name: "‰∏∞Êî∂",
                description: "‰ªäÂπ¥‰ΩúÁâ©‰∏∞Êî∂ÔºåÂ∏ÇÂú∫ÁπÅËç£ÔºåÂêÑÁ±ªÂïÜÂìÅ‰ª∑Ê†ºË∂ã‰∫éÁ®≥ÂÆö„ÄÇ",
                effect: {
                    type: "global",
                    volatility: -0.1,
                    trend: 0.05
                },
                duration: 2
            },
            {
                name: "Êó±ÁÅæ",
                description: "ËøëÊúüÂπ≤Êó±‰∏•ÈáçÔºåÂÜú‰ΩúÁâ©Ê≠âÊî∂ÔºåÂ∏ÇÂú∫Ê≥¢Âä®Âä†Ââß„ÄÇ",
                effect: {
                    type: "category",
                    target: "silverNote",
                    volatility: 0.2,
                    trend: 0.1
                },
                duration: 1
            },
            {
                name: "Êàò‰∫ãÊ∂àÊÅØ",
                description: "ËæπÂ¢É‰º†Êù•Êàò‰∫ãÊ∂àÊÅØÔºåË¥µÈáçÁâ©ÂìÅ‰ª∑Ê†º‰∏äÊ∂®ÔºåÂ∏ÇÂú∫ÊÅêÊÖåÂä†Ââß„ÄÇ",
                effect: {
                    type: "category",
                    target: "gold",
                    volatility: 0.15,
                    trend: 0.2
                },
                duration: 3
            },
            {
                name: "ÂÆòÂëò‰∏ã‰π°",
                description: "ÊúùÂª∑ÂÆòÂëò‰∏ã‰π°Â∑°ËßÜÔºåÊâãÂ∑•Ëâ∫ÂìÅÂèäÈìúÂô®ÈúÄÊ±Ç‰∏äÊ∂®„ÄÇ",
                effect: {
                    type: "items",
                    target: ["bronze_vessel", "calligraphy", "silk"],
                    trend: 0.3
                },
                duration: 1
            },
            {
                name: "Â§ñÂïÜÊù•ËÆø",
                description: "Â§ñÂõΩÂïÜÈòüÊäµËææÔºåÂØπÂºÇÂüüÁâ©ÂìÅÂíåÁ®ÄÊúâÈ¶ôÊñôÈúÄÊ±ÇÂ§ßÂ¢û„ÄÇ",
                effect: {
                    type: "items",
                    target: ["spice", "foreign_trinket", "silk"],
                    trend: 0.25
                },
                duration: 2
            },
            {
                name: "ËäÇÂ∫ÜÊù•‰∏¥",
                description: "ÈáçË¶ÅËäÇÊó•Âç≥Â∞ÜÂà∞Êù•Ôºå‰∫∫‰ª¨‰∫âÁõ∏Ë¥≠‰π∞Á§ºÂìÅÂíåÈ£üÁâ©Ôºå‰ª∑Ê†ºÊ∞¥Ê∂®ËàπÈ´ò„ÄÇ",
                effect: {
                    type: "items",
                    target: ["candies", "luxury_food", "fruit", "tea"],
                    trend: 0.2
                },
                duration: 1
            },
            {
                name: "ÈõÖÈõÜÊ¥ªÂä®",
                description: "Êú¨Âú∞Êñá‰∫∫‰∏æÂäûÈõÖÈõÜÔºåÂØπ‰π¶Ê≥ï„ÄÅÂ≠óÁîªÂíåÂè§Á±çÈúÄÊ±ÇÂ¢ûÂä†„ÄÇ",
                effect: {
                    type: "items",
                    target: ["ancient_book", "calligraphy", "painting"],
                    trend: 0.2
                },
                duration: 2
            },
            {
                name: "ÁòüÁñ´‰º†Ë®Ä",
                description: "ÂùäÈó¥ÊµÅ‰º†ÁòüÁñ´Ê∂àÊÅØÔºåËçØÊùê‰ª∑Ê†ºÈ£ôÂçáÔºåÂ∏ÇÂú∫ÊÅêÊÖå„ÄÇ",
                effect: {
                    type: "items",
                    target: ["medicine", "tea"],
                    trend: 0.4
                },
                duration: 2
            },
            {
                name: "ÊúùÂª∑Êî∂Á®é",
                description: "ÊúùÂª∑ÂºÄÂßãÊî∂Á®éÔºåÊ∞ëÈó¥ÊµÅÂä®ËµÑÈáëÂáèÂ∞ëÔºåÂ•¢‰æàÂìÅ‰ª∑Ê†º‰∏ãÈôç„ÄÇ",
                effect: {
                    type: "items",
                    target: ["gold_jewelry", "jade", "painting", "silver_jewelry"],
                    trend: -0.15
                },
                duration: 1
            },
            {
                name: "Ë¥ßÂ∏ÅË¥¨ÂÄº",
                description: "Èì∂Á•®‰ø°Áî®‰∏ãÈôçÔºå‰∫∫‰ª¨Á∫∑Á∫∑Ë¥≠‰π∞ÂÆûÁâ©‰øùÂÄº„ÄÇ",
                effect: {
                    type: "currency",
                    target: "silverNote",
                    multiplier: 0.8
                },
                duration: 2
            },
            {
                name: "ÈáëÁ•®ÂçáÂÄº",
                description: "ÈáëÁ•®ÂèóÂà∞Â∏ÇÂú∫ËøΩÊçßÔºå‰ΩøÁî®ÈáëÁ•®‰∫§ÊòìÊõ¥ÂàíÁÆó„ÄÇ",
                effect: {
                    type: "currency",
                    target: "goldNote",
                    multiplier: 1.2
                },
                duration: 2
            },
            // Add all additional events
            ...additionalMarketEvents
        ];

        // New additional game events
        const additionalGameEvents = [
            {
                name: "Á•ûÁßòÂïÜ‰∫∫",
                description: "‰∏Ä‰ΩçÁ•ûÁßòÂïÜ‰∫∫ÊÇÑÊÇÑÊé•Ëøë‰Ω†ÔºåÁß∞ÊúâÁâπÊÆäÁöÑÂïÜÂìÅË¶ÅÂçñ„ÄÇ",
                options: [
                    {
                        text: "Êü•ÁúãÂïÜÂìÅ",
                        effect: () => {
                            // Pick a random rare item
                            const randomRareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                            // Discount the price
                            const discountedPrice = Math.floor(randomRareItem.price * 0.7);
                            
                            showNotification(`Á•ûÁßòÂïÜ‰∫∫Â±ïÁ§∫‰∫Ü${randomRareItem.name}${randomRareItem.icon}ÔºåÂéü‰ª∑${formatCurrency(randomRareItem.price, 'Èáë')}ÔºåÁé∞Âè™Ë¶Å${formatCurrency(discountedPrice, 'Èáë')}ÔºÅ`);
                            
                            // Create temporary purchase option
                            const confirmPurchase = confirm(`ÊòØÂê¶Ë¥≠‰π∞${randomRareItem.name}Ôºü‰ª∑Ê†ºÔºö${formatCurrency(discountedPrice, 'Èáë')}`);
                            
                            if (confirmPurchase) {
                                if (gameState.currencies[randomRareItem.currency] >= discountedPrice) {
                                    // Purchase the item
                                    gameState.currencies[randomRareItem.currency] -= discountedPrice;
                                    
                                    // Add to inventory
                                    if (!gameState.inventory[randomRareItem.id]) {
                                        gameState.inventory[randomRareItem.id] = {
                                            ...randomRareItem,
                                            quantity: 1,
                                            purchasePrice: discountedPrice
                                        };
                                    } else {
                                        gameState.inventory[randomRareItem.id].quantity += 1;
                                        // Update average purchase price
                                        gameState.inventory[randomRareItem.id].purchasePrice = Math.floor(
                                            (gameState.inventory[randomRareItem.id].purchasePrice * (gameState.inventory[randomRareItem.id].quantity - 1) + discountedPrice) / 
                                            gameState.inventory[randomRareItem.id].quantity
                                        );
                                    }
                                    
                                    showNotification(`‰Ω†ÊàêÂäüË¥≠‰π∞‰∫Ü${randomRareItem.name}ÔºÅ`);
                                    gameState.reputation += 5;
                                    addExperience(randomRareItem.rarity * 10);
                                    updateCurrencyDisplay();
                                    updateInventoryDisplay();
                                    
                                    // Track statistics
                                    gameState.statistics.totalPurchases += 1;
                                    gameState.statistics.mostExpensivePurchase = Math.max(gameState.statistics.mostExpensivePurchase, discountedPrice);
                                    
                                    return true;
                                } else {
                                    showNotification("‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑÈí±Ë¥≠‰π∞Ëøô‰ª∂ÂÆùÁâ©„ÄÇÁ•ûÁßòÂïÜ‰∫∫Â§±ÊúõÂú∞Á¶ªÂºÄ‰∫Ü„ÄÇ");
                                    return true;
                                }
                            } else {
                                showNotification("‰Ω†ÊãíÁªù‰∫ÜÁ•ûÁßòÂïÜ‰∫∫ÁöÑ‰∫§ÊòìÔºå‰ªñÊÇÑÁÑ∂Á¶ªÂéª„ÄÇ");
                                return true;
                            }
                        }
                    },
                    {
                        text: "Â©âÊãí‰∫§Êòì",
                        effect: () => {
                            showNotification("‰Ω†Â©âÊãí‰∫ÜÁ•ûÁßòÂïÜ‰∫∫Ôºå‰ªñÁïô‰∏ã‰∫Ü‰∏Ä‰∏™Â∞èÂåÖË£π‰æøÂåÜÂåÜÁ¶ªÂéª„ÄÇÈáåÈù¢Êúâ‰∏Ä‰∫õÈì∂Á•®„ÄÇ");
                            gameState.currencies.silverNote += 20000;
                            updateCurrencyDisplay();
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Â§ßÁõóÊù•Ë¢≠",
                description: "‰∏Ä‰ºôÁõóË¥ºÁ™ÅÁÑ∂Âá∫Áé∞Âú®Â∏ÇÂú∫ÔºåÂ®ÅËÉÅË¶ÅÊä¢Ëµ∞ÊâÄÊúâÂïÜÊà∑ÁöÑË¥ßÁâ©ÔºÅ",
                options: [
                    {
                        text: "‰∏éÂÖ∂‰ªñÂïÜ‰∫∫ËÅîÊâãÊäµÊäó",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.6) {
                                showNotification("Âú®‰Ω†ÁöÑÂ∏¶È¢Ü‰∏ãÔºåÂïÜÊà∑‰ª¨ÊàêÂäüËµ∂Ëµ∞‰∫ÜÁõóË¥º„ÄÇÂÆòÂ∫úÂ•ñÂä±‰∫Ü‰Ω†‰∏ÄÁ¨îÈì∂‰∏§ÂíåÂ£∞ÊúõÔºÅ");
                                gameState.currencies.silverIngot += 50000;
                                gameState.reputation += 25;
                                updateCurrencyDisplay();
                                return true;
                            } else {
                                // Lose some currency
                                const lossAmount = Math.floor(gameState.currencies.silverIngot * 0.3);
                                gameState.currencies.silverIngot -= lossAmount;
                                
                                showNotification(`ÁõóË¥ºÂ§™Âº∫‰∫ÜÔºåÂïÜÊà∑‰ª¨Â•ãÂäõÊäµÊäó‰ªçÊçüÂ§±‰∫Ü‰∏Ä‰∫õË¥¢Áâ©„ÄÇ‰Ω†Â§±Âéª‰∫Ü${formatCurrency(lossAmount, 'Èì∂')}Ôºå‰ΩÜÂ£∞ÊúõÊúâÊâÄÊèêÂçá„ÄÇ`);
                                gameState.reputation += 10;
                                updateCurrencyDisplay();
                                return true;
                            }
                        }
                    },
                    {
                        text: "ÊîØ‰ªò‰øùÊä§Ë¥π",
                        effect: () => {
                            // Calculate protection money
                            const protectionFee = Math.floor(gameState.currencies.silverIngot * 0.15);
                            
                            if (gameState.currencies.silverIngot >= protectionFee) {
                                gameState.currencies.silverIngot -= protectionFee;
                                
                                showNotification(`‰Ω†ÊîØ‰ªò‰∫Ü${formatCurrency(protectionFee, 'Èì∂')}‰Ωú‰∏∫‰øùÊä§Ë¥πÔºåÁõóË¥ºÊîæËøá‰∫Ü‰Ω†ÁöÑÂïÜÊëä„ÄÇ`);
                                updateCurrencyDisplay();
                                return true;
                            } else {
                                // Not enough to pay, lose more
                                const availableSilver = gameState.currencies.silverIngot;
                                gameState.currencies.silverIngot = 0;
                                
                                showNotification(`‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑÈì∂‰∏§ÊîØ‰ªò‰øùÊä§Ë¥πÔºåÁõóË¥ºÊä¢Ëµ∞‰∫Ü‰Ω†ÊâÄÊúâÁöÑÈì∂‰∏§Ôºà${formatCurrency(availableSilver, 'Èì∂')}ÔºâÔºÅ`);
                                updateCurrencyDisplay();
                                return true;
                            }
                        }
                    }
                ]
            },
            {
                name: "Â§©ÈôçÊ®™Ë¥¢",
                description: "Á™ÅÁÑ∂Ôºå‰∏ÄÊîØÂÆòÂ∫úÂïÜÈòüÁªèËøáÔºåÂá†ÁÆ±Ë¥ßÁâ©‰∏çÊÖéË∑åËêΩÂú®‰Ω†ÁöÑÊëä‰ΩçÊóÅ„ÄÇÂÆòÂÖµÂåÜÂøôÁ¶ªÂéªÔºå‰ºº‰πéÊ≤°ÊúâÂèëÁé∞„ÄÇ",
                options: [
                    {
                        text: "ÂΩíËøòÂÆòÂ∫ú",
                        effect: () => {
                            showNotification("‰Ω†ËØöÂÆûÂú∞Â∞ÜË¥ßÁâ©ÂΩíËøòÁªôÂÆòÂ∫ú„ÄÇÂÆòÂ∫úÂ§ß‰∏∫ÊÑüÂä®ÔºåÁªô‰∫à‰Ω†ÈáçÈáçÂ•ñËµèÂíåË°®ÂΩ∞ÔºÅ");
                            gameState.currencies.goldIngot += 30000;
                            gameState.reputation += 50;
                            updateCurrencyDisplay();
                            
                            // Special achievement for honesty
                            if (!gameState.unlockedAchievements.includes('honest_merchant')) {
                                gameState.unlockedAchievements.push('honest_merchant');
                                showNotification("Ëß£ÈîÅÊàêÂ∞±ÔºöËØöÂÆûÂïÜ‰∫∫ÔºÅ");
                                addExperience(50);
                            }
                            
                            return true;
                        }
                    },
                    {
                        text: "ÊÇÑÊÇÑÊçÆ‰∏∫Â∑±Êúâ",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.3) {
                                showNotification("‰Ω†Ë¢´‰∫∫ÂèëÁé∞ÁßÅËóèÂÆòÂ∫úË¥¢Áâ©ÔºåÂÆòÂÖµÂ∞Ü‰Ω†ÊãòÊçïÂπ∂Â§Ñ‰ª•ÈáçÁΩöÔºÅ");
                                
                                // Lose significant money and reputation
                                gameState.currencies.goldIngot = Math.floor(gameState.currencies.goldIngot * 0.5);
                                gameState.currencies.silverIngot = Math.floor(gameState.currencies.silverIngot * 0.5);
                                gameState.reputation -= 30;
                                
                                if (gameState.reputation < 0) {
                                    gameState.reputation = 0;
                                }
                                
                                updateCurrencyDisplay();
                                return true;
                            } else {
                                // Add random valuable items to inventory
                                let itemsAdded = 0;
                                for (let i = 0; i < 3; i++) {
                                    if (Math.random() < 0.7) {
                                        const randomRareItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                        
                                        if (!gameState.inventory[randomRareItem.id]) {
                                            gameState.inventory[randomRareItem.id] = {
                                                ...randomRareItem,
                                                quantity: 1,
                                                purchasePrice: 0 // Got for free
                                            };
                                        } else {
                                            gameState.inventory[randomRareItem.id].quantity += 1;
                                        }
                                        
                                        itemsAdded++;
                                    }
                                }
                                
                                showNotification(`‰Ω†ÊÇÑÊÇÑÂ∞ÜË¥ßÁâ©ÊçÆ‰∏∫Â∑±ÊúâÔºåËé∑Âæó‰∫Ü${itemsAdded}‰ª∂ÁèçË¥µÁâ©ÂìÅÔºÅ`);
                                updateInventoryDisplay();
                                return true;
                            }
                        }
                    }
                ]
            },
            {
                name: "ÊÄ™ÂºÇÂ§©Ë±°",
                description: "Â§©Á©∫Âá∫Áé∞ÂºÇË±°Ôºå‰∫∫‰ª¨Á∫∑Á∫∑ËÆÆËÆ∫ËøôÊòØÂêâÂÖÜËøòÊòØÂá∂ÂÖÜ„ÄÇÂ∏ÇÂú∫ÊÉÖÁª™È´òÂ∫¶Á¥ßÂº†„ÄÇ",
                options: [
                    {
                        text: "È¢ÑË®ÄÂ•ΩËøêÂ∞ÜËá≥",
                        effect: () => {
                            showNotification("‰Ω†Â§ßÂ£∞ÂÆ£Áß∞ËøôÊòØÁ••Áëû‰πãÂÖÜÔºåÂ∏ÇÂú∫Â∞ÜÁπÅËç£ÊòåÁõõ„ÄÇ‰∫∫‰ª¨ÂèóÂà∞ÈºìËàûÔºåÂ∏ÇÂú∫ÊÉÖÁª™È´òÊ∂®ÔºÅ");
                            
                            // Create positive market effect
                            gameState.events.push({
                                name: "Á••ÁëûÈ¢ÑË®Ä",
                                description: "Â∏ÇÂú∫ÂÖÖÊª°‰πêËßÇÊÉÖÁª™Ôºå‰∫§ÊòìÊ¥ªË∑É„ÄÇ",
                                effect: {
                                    type: "global",
                                    volatility: 0.3,
                                    trend: 0.2
                                },
                                duration: 3
                            });
                            
                            gameState.reputation += 10;
                            updateCurrencyDisplay();
                            updateMarket();
                            return true;
                        }
                    },
                    {
                        text: "È¢ÑË®ÄÁÅæÈöæÂ∞ÜËá≥",
                        effect: () => {
                            showNotification("‰Ω†Ë≠¶ÂëäÂ§ßÂÆ∂ËøôÊòØ‰∏çÁ••‰πãÂÖÜÔºåÁÅæÈöæÂç≥Â∞ÜÊù•‰∏¥„ÄÇÂ∏ÇÂú∫Èô∑ÂÖ•ÊÅêÊÖåÔºåÁâ©‰ª∑Â§ßÂπÖÊ≥¢Âä®ÔºÅ");
                            
                            // Create negative market effect
                            gameState.events.push({
                                name: "ÁÅæÈöæÈ¢ÑË®Ä",
                                description: "Â∏ÇÂú∫ÊÅêÊÖåËîìÂª∂ÔºåÁâ©‰ª∑ÂâßÁÉàÊ≥¢Âä®„ÄÇ",
                                effect: {
                                    type: "global",
                                    volatility: 0.8,
                                    trend: -0.1
                                },
                                duration: 2
                            });
                            
                            // But you can profit from the chaos
                            gameState.currencies.silverIngot += 30000;
                            showNotification("Âú®Ê∑∑‰π±‰∏≠Ôºå‰Ω†Êöó‰∏≠Êî∂Ë¥≠‰∫Ü‰Ωé‰ª∑ÊäõÂîÆÁöÑÁâ©ÂìÅÔºåËé∑Âà©È¢á‰∏∞ÔºÅ");
                            
                            updateCurrencyDisplay();
                            updateMarket();
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Èì∏Â∏ÅÂéÇ‰∫ãÊïÖ",
                description: "ÊúùÂª∑Èì∏Â∏ÅÂéÇÂèëÁîüÂ§ßÁÅ´ÔºåÊñ∞Èì∏ÈÄ†ÁöÑÈì∂Â∏ÅÊï∞ÈáèÈîêÂáè„ÄÇ",
                options: [
                    {
                        text: "Âõ§ÁßØÈì∂‰∏§",
                        effect: () => {
                            if (gameState.currencies.silverIngot < 50000) {
                                showNotification("‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑÈì∂‰∏§ËøõË°åÂõ§ÁßØ„ÄÇÈîôÂ§±‰∫Ü‰∏ÄÊ¨°ÊäïËµÑÊú∫‰ºö„ÄÇ");
                                return true;
                            }
                            
                            // Lock some silver but get higher return later
                            const investAmount = Math.min(gameState.currencies.silverIngot, 100000);
                            gameState.currencies.silverIngot -= investAmount;
                            
                            showNotification(`‰Ω†Âõ§ÁßØ‰∫Ü${formatCurrency(investAmount, 'Èì∂')}ÔºåÁ≠âÂæÖ‰ª∑Ê†º‰∏äÊ∂®„ÄÇ3‰∏™Â∏ÇÂú∫Âë®ÊúüÂêéÂ∞ÜËé∑ÂæóÊî∂Áõä„ÄÇ`);
                            
                            // Create timeout to return investment with profit
                            setTimeout(() => {
                                const returnAmount = Math.floor(investAmount * 1.8);
                                gameState.currencies.silverIngot += returnAmount;
                                showNotification(`‰Ω†Âõ§ÁßØÁöÑÈì∂‰∏§Â¢ûÂÄº‰∫ÜÔºÅËé∑Âæó${formatCurrency(returnAmount, 'Èì∂')}„ÄÇ`);
                                updateCurrencyDisplay();
                            }, 3 * 15 * 1000); // 3 market cycles
                            
                            updateCurrencyDisplay();
                            return true;
                        }
                    },
                    {
                        text: "Á´ãÂç≥ËΩ¨ÊäïÈáëÂ≠ê",
                        effect: () => {
                            // Convert half of silver to gold
                            const convertAmount = Math.floor(gameState.currencies.silverIngot / 2);
                            gameState.currencies.silverIngot -= convertAmount;
                            gameState.currencies.goldIngot += Math.floor(convertAmount / 80); // Better than normal exchange rate
                            
                            showNotification(`‰Ω†ËøÖÈÄüÂ∞Ü‰∏ÄÂçäÁöÑÈì∂‰∏§ÂÖëÊç¢Êàê‰∫ÜÈáëÂ≠êÔºåÊä¢Âú®‰ª∑Ê†ºÂèòÂä®ÂâçÂÆåÊàê‰∫ÜË¥ßÂ∏ÅËΩ¨Êç¢„ÄÇ`);
                            updateCurrencyDisplay();
                            return true;
                        }
                    }
                ]
            }
        ];

        // Combine original game events with additional ones
        const gameEvents = [
            {
                name: "Ë¥µÂÆ¢‰∏äÈó®",
                description: "‰∏Ä‰ΩçÂØåÂïÜÊù•Âà∞‰Ω†ÁöÑÊëä‰ΩçÔºå‰ªñÊÑøÊÑè‰ª•È´ò‰ª∑Ë¥≠‰π∞‰Ω†ÁöÑÁ®ÄÊúâÁâ©ÂìÅ„ÄÇ",
                options: [
                    {
                        text: "Êé•Âèó‰∫§Êòì",
                        effect: () => {
                            // Find rare items in inventory
                            const rareItems = Object.values(gameState.inventory).filter(item => item.rarity >= 3);
                            if (rareItems.length > 0) {
                                // Sell the first rare item at double price
                                const item = rareItems[0];
                                gameState.inventory[item.id].quantity -= 1;
                                
                                // Higher sale price
                                const bonus = item.resalePrice * 2;
                                
                                // Add currency
                                if (item.currency === 'goldIngot') {
                                    gameState.currencies.goldIngot += bonus;
                                } else if (item.currency === 'goldNote') {
                                    gameState.currencies.goldNote += bonus;
                                } else if (item.currency === 'silverIngot') {
                                    gameState.currencies.silverIngot += bonus;
                                } else {
                                    gameState.currencies.silverNote += bonus;
                                }
                                
                                // Remove from inventory if quantity is 0
                                if (gameState.inventory[item.id].quantity === 0) {
                                    delete gameState.inventory[item.id];
                                }
                                
                                showNotification(`Ë¥µÂÆ¢ÂçÅÂàÜÊª°ÊÑèÔºåÁªô‰∫Ü‰Ω†ÂèåÂÄçÁöÑ‰ª∑Ê†ºÔºÅÂ£∞Êúõ+10`);
                                gameState.reputation += 10;
                                
                                // Track statistics
                                gameState.statistics.totalSales += 1;
                                const profit = bonus - (item.purchasePrice || item.price);
                                gameState.statistics.totalProfit += profit;
                                if (profit > gameState.statistics.biggestProfit) {
                                    gameState.statistics.biggestProfit = profit;
                                }
                                
                                return true;
                            } else {
                                showNotification("‰Ω†Ê≤°ÊúâÁ®ÄÊúâÁâ©ÂìÅÂèØ‰ª•Âá∫ÂîÆÔºåË¥µÂÆ¢Â§±ÊúõÁ¶ªÂéª„ÄÇ");
                                return false;
                            }
                        }
                    },
                    {
                        text: "Â©âÊãí",
                        effect: () => {
                            showNotification("‰Ω†Â©âÊãí‰∫ÜË¥µÂÆ¢Ôºå‰ªñÁêÜËß£‰Ω†ÁöÑÂÜ≥ÂÆöÔºåÁªô‰∫Ü‰Ω†‰∏Ä‰∫õÈì∂Á•®‰Ωú‰∏∫Á§ºÁâ©„ÄÇ");
                            gameState.currencies.silverNote += 10000;
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Â∞èÂÅ∑ÂÖâÈ°æ",
                description: "‰∏Ä‰∏™Â∞èÂÅ∑ËØïÂõæÂÅ∑Ëµ∞‰Ω†ÁöÑ‰∏Ä‰∫õË¥ßÁâ©Ôºå‰Ω†Ê≥®ÊÑèÂà∞‰∫Ü‰ªñÁöÑË°å‰∏∫„ÄÇ",
                options: [
                    {
                        text: "Êäì‰ΩèÂ∞èÂÅ∑",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.7) {
                                showNotification("‰Ω†ÊàêÂäüÊäì‰Ωè‰∫ÜÂ∞èÂÅ∑ÔºåÂÆàÂç´Áªô‰∫Ü‰Ω†Â•ñÂä±„ÄÇÂ£∞Êúõ+15");
                                gameState.currencies.silverIngot += 20000;
                                gameState.reputation += 15;
                            } else {
                                showNotification("‰Ω†ËØïÂõæÊäì‰ΩèÂ∞èÂÅ∑Ôºå‰ΩÜ‰ªñÈÄÉËµ∞‰∫ÜÔºåËøòÂ∏¶Ëµ∞‰∫Ü‰∏Ä‰∫õË¥ßÁâ©„ÄÇ");
                                
                                // Lose a random item
                                const inventoryIds = Object.keys(gameState.inventory);
                                if (inventoryIds.length > 0) {
                                    const randomItemId = inventoryIds[Math.floor(Math.random() * inventoryIds.length)];
                                    gameState.inventory[randomItemId].quantity -= 1;
                                    
                                    if (gameState.inventory[randomItemId].quantity === 0) {
                                        delete gameState.inventory[randomItemId];
                                    }
                                }
                            }
                            return true;
                        }
                    },
                    {
                        text: "ÊÇÑÊÇÑÊîæËµ∞",
                        effect: () => {
                            showNotification("‰Ω†ÈÄâÊã©ÊîæËµ∞Â∞èÂÅ∑ÔºåÊï∞Êó•Âêé‰ªñÈÄÅÊù•‰∫Ü‰∏ÄÂ∞ÅÊÑüË∞¢‰ø°Âíå‰∏Ä‰∫õÁ®ÄÊúâÁâ©ÂìÅ‰Ωú‰∏∫ÂõûÊä•„ÄÇ");
                            
                            // Add a random rare item
                            const allItems = [].concat(...Object.values(storeItems));
                            const rareItems = allItems.filter(item => item.rarity >= 3);
                            if (rareItems.length > 0) {
                                const randomItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                                
                                if (!gameState.inventory[randomItem.id]) {
                                    gameState.inventory[randomItem.id] = {
                                        ...randomItem,
                                        quantity: 1
                                    };
                                } else {
                                    gameState.inventory[randomItem.id].quantity += 1;
                                }
                            }
                            
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Â∏ÇÈõÜÊâ©Âº†",
                description: "Â∏ÇÈõÜË¶ÅÊâ©Âª∫ÔºåÂÆòÂëòÈÇÄËØ∑‰Ω†ÊäïËµÑ„ÄÇ",
                options: [
                    {
                        text: "ÊäïËµÑ5‰∏§ÈáëÂ≠ê",
                        effect: () => {
                            if (gameState.currencies.goldIngot >= 5000) {
                                gameState.currencies.goldIngot -= 5000;
                                showNotification("‰Ω†ÊäïËµÑ‰∫ÜÂ∏ÇÈõÜÊâ©Âª∫ÔºåÂÆòÂëòÈùûÂ∏∏ÊÑüË∞¢„ÄÇÂ£∞Êúõ+20Ôºå‰∏ãÊ¨°Â∏ÇÈõÜ‰Ω†Â∞ÜËé∑Âæó‰ºòÊÉ†ÔºÅ");
                                gameState.reputation += 20;
                                
                                // Apply discount for next market cycle
                                for (let category in storeItems) {
                                    storeItems[category].forEach(item => {
                                        item.discount = 0.1; // 10% discount
                                    });
                                }
                                
                                return true;
                            } else {
                                showNotification("‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑÈáëÂ≠êËøõË°åÊäïËµÑ„ÄÇ");
                                return false;
                            }
                        }
                    },
                    {
                        text: "Â©âÊãíÊäïËµÑ",
                        effect: () => {
                            showNotification("‰Ω†Â©âÊãí‰∫ÜÊäïËµÑÈÇÄËØ∑ÔºåÈîôËøá‰∫Ü‰∏ÄÊ¨°ÂïÜÊú∫„ÄÇ");
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Ë°åÂïÜËÅîÁõü",
                description: "‰∏ÄÁæ§Ë°åÂïÜÈÇÄËØ∑‰Ω†Âä†ÂÖ•‰ªñ‰ª¨ÁöÑËÅîÁõüÔºåÂÖ±‰∫´ËµÑÊ∫êÂíå‰ø°ÊÅØ„ÄÇ",
                options: [
                    {
                        text: "Âä†ÂÖ•ËÅîÁõü",
                        effect: () => {
                            showNotification("‰Ω†Âä†ÂÖ•‰∫ÜË°åÂïÜËÅîÁõüÔºåËé∑Âæó‰∫ÜÂ∏ÇÂú∫ÊÉÖÊä•„ÄÇÂ£∞Êúõ+10ÔºåÁé∞Âú®‰Ω†ÂèØ‰ª•Êõ¥Â•ΩÂú∞È¢ÑÊµã‰ª∑Ê†ºÊ≥¢Âä®ÔºÅ");
                            gameState.reputation += 10;
                            
                            // Reveal upcoming price trends
                            for (let category in storeItems) {
                                storeItems[category].forEach(item => {
                                    item.trendVisible = true;
                                });
                            }
                            
                            return true;
                        }
                    },
                    {
                        text: "‰øùÊåÅÁã¨Á´ã",
                        effect: () => {
                            showNotification("‰Ω†ÈÄâÊã©‰øùÊåÅÁã¨Á´ãÁªèËê•ÔºåËé∑Âæó‰∫Ü‰∏Ä‰∫õË°åÂïÜÁöÑÂ∞äÈáçÂíå‰∏ÄÁ¨îÁ§ºÁâ©„ÄÇ");
                            gameState.currencies.goldNote += 10000;
                            gameState.reputation += 5;
                            return true;
                        }
                    }
                ]
            },
            {
                name: "Â∏ÇÂú∫Âç±Êú∫",
                description: "Â∏ÇÂú∫Èô∑ÂÖ•Âç±Êú∫ÔºåË¥ßÂ∏Å‰ª∑ÂÄºÂä®Ëç°Ôºå‰ΩÜ‰πüÊúâÊäïËµÑÊú∫‰ºö„ÄÇ",
                options: [
                    {
                        text: "ÂÖëÊç¢‰∏∫ÈáëÈî≠‰øùÂÄº",
                        effect: () => {
                            // Convert other currencies to gold ingots
                            const silverIngotValue = Math.floor(gameState.currencies.silverIngot / 100);
                            const goldNoteValue = Math.floor(gameState.currencies.goldNote * 0.8);
                            const silverNoteValue = Math.floor(gameState.currencies.silverNote * 0.8 / 100);
                            
                            gameState.currencies.silverIngot = 0;
                            gameState.currencies.goldNote = 0;
                            gameState.currencies.silverNote = 0;
                            
                            const totalValue = silverIngotValue + goldNoteValue + silverNoteValue;
                            gameState.currencies.goldIngot += totalValue;
                            
                            showNotification(`‰Ω†Â∞ÜÊâÄÊúâË¥ßÂ∏ÅÂÖëÊç¢‰∏∫ÈáëÈî≠‰øùÂÄºÔºåÊàêÂäüÈÅøÂºÄÂ∏ÇÂú∫Ê≥¢Âä®„ÄÇ`);
                            return true;
                        }
                    },
                    {
                        text: "ÊäïÊú∫Â∏ÇÂú∫Ê≥¢Âä®",
                        effect: () => {
                            const random = Math.random();
                            if (random < 0.4) {
                                // Success
                                const bonus = Math.floor((gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100) * 0.5);
                                showNotification(`‰Ω†ÊàêÂäüÈ¢ÑÊµã‰∫ÜÂ∏ÇÂú∫Ê≥¢Âä®ÔºåËé∑Âæó‰∫Ü${formatCurrency(bonus, 'Èì∂')}ÁöÑÂà©Ê∂¶ÔºÅ`);
                                gameState.currencies.silverIngot += bonus;
                            } else {
                                // Loss
                                const loss = Math.floor((gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100) * 0.3);
                                showNotification(`‰Ω†ÁöÑÊäïËµÑÂ§±Ë¥•‰∫ÜÔºåÊçüÂ§±‰∫Ü${formatCurrency(loss, 'Èì∂')}„ÄÇ`);
                                
                                // Distribute loss across currencies
                                const totalValue = gameState.currencies.goldIngot + gameState.currencies.silverIngot/100 + gameState.currencies.goldNote + gameState.currencies.silverNote/100;
                                
                                gameState.currencies.goldIngot -= Math.floor(loss * (gameState.currencies.goldIngot / totalValue));
                                gameState.currencies.silverIngot -= Math.floor(loss * (gameState.currencies.silverIngot/100 / totalValue) * 100);
                                gameState.currencies.goldNote -= Math.floor(loss * (gameState.currencies.goldNote / totalValue));
                                gameState.currencies.silverNote -= Math.floor(loss * (gameState.currencies.silverNote/100 / totalValue) * 100);
                                
                                // Ensure no negative values
                                for (let currency in gameState.currencies) {
                                    if (gameState.currencies[currency] < 0) {
                                        gameState.currencies[currency] = 0;
                                    }
                                }
                            }
                            return true;
                        }
                    }
                ]
            },
            // Add all additional events
            ...additionalGameEvents
        ];

        // Seasons and their effects
        const seasons = [
            {
                name: "Êò•",
                effect: {
                    type: "items",
                    target: ["tea", "medicine", "fruit", "paper"],
                    trend: 0.15
                }
            },
            {
                name: "Â§è",
                effect: {
                    type: "items",
                    target: ["spice", "candies", "wine", "silk"],
                    trend: 0.15
                }
            },
            {
                name: "Áßã",
                effect: {
                    type: "items",
                    target: ["fruit", "luxury_food", "bronze_vessel", "calligraphy"],
                    trend: 0.15
                }
            },
            {
                name: "ÂÜ¨",
                effect: {
                    type: "items",
                    target: ["jade", "gold_jewelry", "silver_jewelry", "painting"],
                    trend: 0.15
                }
            }
        ];

        // Loan options
        const loanOptions = [
            { 
                id: 'small_loan', 
                name: 'Â∞èÈ¢ùË¥∑Ê¨æ', 
                amount: 50000, // 50 tael silver
                currency: 'silverIngot',
                interestRate: 0.1, // 10% interest
                durationCycles: 5,
                minBusinessLevel: 1
            },
            { 
                id: 'medium_loan', 
                name: '‰∏≠È¢ùË¥∑Ê¨æ', 
                amount: 20000, // 20 tael gold
                currency: 'goldIngot',
                interestRate: 0.15, // 15% interest
                durationCycles: 7,
                minBusinessLevel: 2
            },
            { 
                id: 'large_loan', 
                name: 'Â§ßÈ¢ùË¥∑Ê¨æ', 
                amount: 500000, // 500 tael silver
                currency: 'silverIngot',
                interestRate: 0.2, // 20% interest
                durationCycles: 10,
                minBusinessLevel: 3
            },
            { 
                id: 'premium_loan', 
                name: 'È´òÁ´ØË¥∑Ê¨æ', 
                amount: 100000, // 100 tael gold
                currency: 'goldIngot',
                interestRate: 0.25, // 25% interest
                durationCycles: 12,
                minBusinessLevel: 5
            }
        ];

        // Currency display formatter
        const formatCurrency = (wenAmount, type) => {
            const ingots = Math.floor(wenAmount / 1000000);
            const taels = Math.floor((wenAmount % 1000000) / 1000);
            const wens = wenAmount % 1000;
            
            let result = '';
            
            if (ingots > 0) {
                result += `${ingots}Èî≠ `;
            }
            
            if (taels > 0 || ingots > 0) {
                result += `${taels}‰∏§ `;
            }
            
            result += `${wens}Êñá${type}`;
            
            return result;
        };

        // Update currency display
        const updateCurrencyDisplay = () => {
            const currencyDisplay = document.getElementById('currency-display');
            currencyDisplay.innerHTML = `
                <div class="currency-item gold">
                    <h3>ÈáëÂ≠ê</h3>
                    <p>${formatCurrency(gameState.currencies.goldIngot, 'Èáë')}</p>
                    <span class="currency-special">üíé</span>
                </div>
                <div class="currency-item gold">
                    <h3>ÈáëÁ•®</h3>
                    <p>${formatCurrency(gameState.currencies.goldNote, 'ÈáëÁ•®')}</p>
                    <span class="currency-special">üìà</span>
                </div>
                <div class="currency-item silver">
                    <h3>Èì∂Â≠ê</h3>
                    <p>${formatCurrency(gameState.currencies.silverIngot, 'Èì∂')}</p>
                    <span class="currency-special">üîÑ</span>
                </div>
                <div class="currency-item silver">
                    <h3>Èì∂Á•®</h3>
                    <p>${formatCurrency(gameState.currencies.silverNote, 'Èì∂Á•®')}</p>
                    <span class="currency-special">üîç</span>
                </div>
            `;
            
            // Update stats display
            document.getElementById('business-level').textContent = gameState.businessLevel;
            document.getElementById('reputation').textContent = gameState.reputation;
            document.getElementById('game-date').textContent = `Á¨¨${gameState.date.year}Âπ¥ ${seasons[gameState.date.season].name}`;
            document.getElementById('level-progress').style.width = `${gameState.levelProgress}%`;
            
            // Check for achievements
            checkAchievements();
        };

        // Currency conversion options
        const setupCurrencySection = () => {
            const currencySection = document.getElementById('currency-section').querySelector('.section-content');
            
            // Calculate max tael that can be exchanged
            const maxGoldIngotTael = Math.floor(gameState.currencies.goldIngot / 1000);
            const maxGoldNoteTael = Math.floor(gameState.currencies.goldNote / 1000);
            const maxSilverIngotTael = Math.floor(gameState.currencies.silverIngot / 1000);
            const maxSilverNoteTael = Math.floor(gameState.currencies.silverNote / 1000);
            
            currencySection.innerHTML = `
                <div class="conversion-option">
                    <h3>ÂÖëÊç¢Èì∂Â≠ê</h3>
                    <p>1‰∏§ÈáëÂ≠ê = 100‰∏§Èì∂Â≠ê</p>
                    <div>
                        <input type="number" id="gold-to-silver-ingot" min="0" max="${maxGoldIngotTael}" value="0">
                        <button id="exchange-gold-to-silver">ÂÖëÊç¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>ÂÖëÊç¢Èì∂Á•®</h3>
                    <p>1‰∏§ÈáëÁ•® = 100‰∏§Èì∂Á•®</p>
                    <div>
                        <input type="number" id="gold-note-to-silver-note" min="0" max="${maxGoldNoteTael}" value="0">
                        <button id="exchange-gold-note-to-silver-note">ÂÖëÊç¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>ÈáëÂ≠êËΩ¨ÈáëÁ•®</h3>
                    <p>ÂÖëÊç¢ÊâãÁª≠Ë¥πÔºö5%</p>
                    <div>
                        <input type="number" id="gold-to-gold-note" min="0" max="${maxGoldIngotTael}" value="0">
                        <button id="exchange-gold-to-gold-note">ÂÖëÊç¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>Èì∂Â≠êËΩ¨Èì∂Á•®</h3>
                    <p>ÂÖëÊç¢ÊâãÁª≠Ë¥πÔºö5%</p>
                    <div>
                        <input type="number" id="silver-to-silver-note" min="0" max="${maxSilverIngotTael}" value="0">
                        <button id="exchange-silver-to-silver-note">ÂÖëÊç¢</button>
                    </div>
                </div>
                <div class="conversion-option">
                    <h3>Êü•ÁúãË¥ßÂ∏ÅÁâπÊÄß</h3>
                    <button id="view-currency-effects">Êü•ÁúãËØ¶ÊÉÖ</button>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('exchange-gold-to-silver').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-to-silver-ingot').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldIngot) {
                    gameState.currencies.goldIngot -= wenAmount;
                    gameState.currencies.silverIngot += wenAmount * 100; // 1 Gold = 100 Silver
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`ÊàêÂäüÂÖëÊç¢ ${taelAmount}‰∏§ÈáëÂ≠ê ‰∏∫ ${taelAmount * 100}‰∏§Èì∂Â≠ê`);
                    addExperience(taelAmount * 0.5);
                }
            });
            
            document.getElementById('exchange-gold-note-to-silver-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-note-to-silver-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldNote) {
                    gameState.currencies.goldNote -= wenAmount;
                    gameState.currencies.silverNote += wenAmount * 100; // 1 Gold note = 100 Silver notes
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`ÊàêÂäüÂÖëÊç¢ ${taelAmount}‰∏§ÈáëÁ•® ‰∏∫ ${taelAmount * 100}‰∏§Èì∂Á•®`);
                    addExperience(taelAmount * 0.5);
                }
            });
            
            document.getElementById('exchange-gold-to-gold-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('gold-to-gold-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.goldIngot) {
                    gameState.currencies.goldIngot -= wenAmount;
                    gameState.currencies.goldNote += Math.floor(wenAmount * 0.95); // 5% fee
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`ÊàêÂäüÂÖëÊç¢ ${taelAmount}‰∏§ÈáëÂ≠ê ‰∏∫ ${Math.floor(taelAmount * 0.95)}‰∏§ÈáëÁ•®Ôºà5%ÊâãÁª≠Ë¥πÔºâ`);
                    addExperience(taelAmount * 0.3);
                }
            });
            
            document.getElementById('exchange-silver-to-silver-note').addEventListener('click', () => {
                const taelAmount = parseInt(document.getElementById('silver-to-silver-note').value) || 0;
                const wenAmount = taelAmount * 1000; // Convert tael input to wen
                
                if (taelAmount > 0 && wenAmount <= gameState.currencies.silverIngot) {
                    gameState.currencies.silverIngot -= wenAmount;
                    gameState.currencies.silverNote += Math.floor(wenAmount * 0.95); // 5% fee
                    updateCurrencyDisplay();
                    setupCurrencySection(); // Update max values
                    showNotification(`ÊàêÂäüÂÖëÊç¢ ${taelAmount}‰∏§Èì∂Â≠ê ‰∏∫ ${Math.floor(taelAmount * 0.95)}‰∏§Èì∂Á•®Ôºà5%ÊâãÁª≠Ë¥πÔºâ`);
                    addExperience(taelAmount * 0.2);
                }
            });
            
            document.getElementById('view-currency-effects').addEventListener('click', () => {
                let message = "Ë¥ßÂ∏ÅÁâπÊÄßÔºö\n\n";
                for (let currency in gameState.currencyEffects) {
                    const effect = gameState.currencyEffects[currency];
                    let currencyName = "";
                    switch(currency) {
                        case 'goldIngot': currencyName = "ÈáëÂ≠ê"; break;
                        case 'goldNote': currencyName = "ÈáëÁ•®"; break;
                        case 'silverIngot': currencyName = "Èì∂Â≠ê"; break;
                        case 'silverNote': currencyName = "Èì∂Á•®"; break;
                    }
                    message += `${currencyName} - ${effect.name}Ôºö${effect.effect}Ôºå${effect.bonus}\n`;
                }
                showNotification(message);
            });
        };

        // Gold egg gambling mechanics
        const setupGoldEggSection = () => {
            const goldEggSection = document.getElementById('gold-egg-section').querySelector('.section-content');
            
            // Get gold note bonus from currency effect
            const goldNoteBonusMultiplier = 1.2; // 20% bonus from gold note
            
            goldEggSection.innerHTML = `
                <p>Ëä±Ë¥π5‰∏§ÈáëÂ≠êÁ†∏ÂºÄÈáëËõãÔºåÊúâÊú∫‰ºöËé∑ÂæóÈáëÁ•®ÊàñÈì∂Á•®ÔºÅ</p>
                <p><small>‰ΩøÁî®ÈáëÁ•®ÊäΩÂ•ñÂèØËé∑ÂæóÈ¢ùÂ§ñÂ•ñÂä±ÔºÅ</small></p>
                <div id="gold-egg" class="pulse">ü•ö</div>
                <p id="egg-result"></p>
                <div>
                    <button id="use-gold-ingot">‰ΩøÁî®ÈáëÂ≠ê (5‰∏§)</button>
                    <button id="use-gold-note">‰ΩøÁî®ÈáëÁ•® (5‰∏§)</button>
                </div>
            `;
            
            document.getElementById('use-gold-ingot').addEventListener('click', () => {
                if (gameState.currencies.goldIngot >= gameState.eggCost) {
                    gameState.currencies.goldIngot -= gameState.eggCost;
                    crackEgg(false);
                } else {
                    document.getElementById('egg-result').textContent = `ÈáëÂ≠ê‰∏çË∂≥ÔºåÊó†Ê≥ïÁ†∏ËõãÔºÅ`;
                }
            });
            
            document.getElementById('use-gold-note').addEventListener('click', () => {
                if (gameState.currencies.goldNote >= gameState.eggCost) {
                    gameState.currencies.goldNote -= gameState.eggCost;
                    crackEgg(true);
                } else {
                    document.getElementById('egg-result').textContent = `ÈáëÁ•®‰∏çË∂≥ÔºåÊó†Ê≥ïÁ†∏ËõãÔºÅ`;
                }
            });
        };
        
        // Crack egg function
        const crackEgg = (useGoldNote) => {
            // Random result
            const result = Math.random();
            let message = '';
            
            // Apply gold note bonus if applicable
            const bonusMultiplier = useGoldNote ? 1.2 : 1.0;
            
            if (result < 0.1 * bonusMultiplier) { // 10% chance to get big win (12% with gold note)
                const goldNotes = Math.floor((Math.random() * 50 + 50) * bonusMultiplier); // 50-100 tael
                const silverNotes = Math.floor((Math.random() * 1000 + 1000) * bonusMultiplier); // 1000-2000 tael
                gameState.currencies.goldNote += goldNotes * 1000; // Convert tael to wen
                gameState.currencies.silverNote += silverNotes * 1000; // Convert tael to wen
                message = `ÊÅ≠ÂñúÔºÅËé∑Âæó‰∫Ü${goldNotes}‰∏§ÈáëÁ•®Âíå${silverNotes}‰∏§Èì∂Á•®ÔºÅ`;
                addExperience(50);
            } else if (result < 0.3 * bonusMultiplier) { // 20% chance to get medium win (24% with gold note)
                const goldNotes = Math.floor((Math.random() * 30 + 20) * bonusMultiplier); // 20-50 tael
                gameState.currencies.goldNote += goldNotes * 1000; // Convert tael to wen
                message = `‰∏çÈîôÔºÅËé∑Âæó‰∫Ü${goldNotes}‰∏§ÈáëÁ•®ÔºÅ`;
                addExperience(20);
            } else if (result < 0.6 * bonusMultiplier) { // 30% chance to get small win (36% with gold note)
                const silverNotes = Math.floor((Math.random() * 500 + 100) * bonusMultiplier); // 100-600 tael
                gameState.currencies.silverNote += silverNotes * 1000; // Convert tael to wen
                message = `Ëé∑Âæó‰∫Ü${silverNotes}‰∏§Èì∂Á•®ÔºÅ`;
                addExperience(10);
            } else { // chance to lose
                if (useGoldNote && Math.random() < 0.3) {
                    // Consolation prize when using gold note
                    const silverNotes = Math.floor(Math.random() * 100 + 50); // 50-150 tael
                    gameState.currencies.silverNote += silverNotes * 1000;
                    message = `ËøêÊ∞î‰∏ç‰Ω≥Ôºå‰ΩÜÁî±‰∫é‰ΩøÁî®ÈáëÁ•®ÔºåËé∑Âæó‰∫Ü${silverNotes}‰∏§Èì∂Á•®‰Ωú‰∏∫ÂÆâÊÖ∞„ÄÇ`;
                    addExperience(5);
                } else {
                    message = `ÂæàÈÅóÊÜæÔºåËøô‰∏™ËõãÊòØÁ©∫ÁöÑÔºÅ`;
                    addExperience(2);
                }
            }
            
            document.getElementById('egg-result').textContent = message;
            updateCurrencyDisplay();
            setupCurrencySection(); // Update max values
            
            // Track statistics
            gameState.statistics.totalEggsOpen += 1;
        };

        // Setup store tabs
        const setupStoreTabs = () => {
            document.getElementById('gold-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'gold';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('gold-store-tab').classList.add('active');
            });
            
            document.getElementById('silver-ingot-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'silverIngot';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('silver-ingot-store-tab').classList.add('active');
            });
            
            document.getElementById('silver-note-store-tab').addEventListener('click', () => {
                gameState.activeStore = 'silverNote';
                updateStoreDisplay();
                
                // Update active tab
                document.querySelectorAll('#store-tabs button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('silver-note-store-tab').classList.add('active');
            });
            
            // Set initial active tab
            document.getElementById('gold-store-tab').classList.add('active');
        };

        // Update store display
        const updateStoreDisplay = () => {
            const storeContent = document.getElementById('store-content');
            storeContent.innerHTML = '';
            
            const items = storeItems[gameState.activeStore];
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.classList.add('store-item');
                
                let currencySymbol = '';
                let currencyName = '';
                
                switch(item.currency) {
                    case 'goldIngot':
                        currencySymbol = 'Èáë';
                        currencyName = 'ÈáëÂ≠ê';
                        break;
                    case 'goldNote':
                        currencySymbol = 'ÈáëÁ•®';
                        currencyName = 'ÈáëÁ•®';
                        break;
                    case 'silverIngot':
                        currencySymbol = 'Èì∂';
                        currencyName = 'Èì∂Â≠ê';
                        break;
                    case 'silverNote':
                        currencySymbol = 'Èì∂Á•®';
                        currencyName = 'Èì∂Á•®';
                        break;
                }
                
                // Format prices for display
                const displayPrice = formatCurrency(item.price, currencySymbol);
                const displayResalePrice = formatCurrency(item.resalePrice, currencySymbol);
                
                // Price trend indicator
                let trendClass = '';
                let trendSymbol = '';
                if (item.trend > 0.1) {
                    trendClass = 'price-up';
                    trendSymbol = '‚Üë';
                } else if (item.trend < -0.1) {
                    trendClass = 'price-down';
                    trendSymbol = '‚Üì';
                } else {
                    trendClass = 'price-stable';
                    trendSymbol = '‚Üí';
                }
                
                // Show trend prediction if available
                let trendPrediction = '';
                if (item.trendVisible && Math.abs(item.trend) > 0.05) {
                    trendPrediction = `<p><small>È¢ÑÊµãÔºö‰ª∑Ê†ºÂ∞Ü${item.trend > 0 ? '‰∏äÊ∂®' : '‰∏ãË∑å'}</small></p>`;
                }
                
                // Rarity stars (limited to 3 for mobile)
                let rarityStars = '';
                for (let i = 0; i < Math.min(item.rarity, 3); i++) {
                    rarityStars += '‚≠ê';
                }
                if (item.rarity > 3) {
                    rarityStars += '+' + (item.rarity - 3);
                }
                
                itemElement.innerHTML = `
                    <div class="price-trend ${trendClass}">${trendSymbol}</div>
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-details">
                        <h3>${item.name} ${rarityStars}</h3>
                        <p>Ë¥≠‰π∞: ${displayPrice}</p>
                        <p>Âá∫ÂîÆ: ${displayResalePrice}</p>
                        ${trendPrediction}
                    </div>
                    <div class="item-actions">
                        <button class="buy-btn" data-id="${item.id}">Ë¥≠‰π∞</button>
                    </div>
                `;
                
                storeContent.appendChild(itemElement);
                
                // Add event listener for buy button
                itemElement.querySelector('.buy-btn').addEventListener('click', () => {
                    buyItem(item);
                });
            });
        };

        // Buy item function
        const buyItem = (item) => {
            const currencyBonus = item.currency === 'goldIngot' ? 0.1 : 0; // 10% more purchasing power with gold ingots
            const effectivePrice = Math.floor(item.price * (1 - currencyBonus));
            
            if (gameState.currencies[item.currency] >= effectivePrice) {
                gameState.currencies[item.currency] -= effectivePrice;
                
                // Add to inventory
                if (!gameState.inventory[item.id]) {
                    gameState.inventory[item.id] = {
                        ...item,
                        quantity: 1,
                        purchasePrice: item.price // Store purchase price for profit calculations
                    };
                } else {
                    gameState.inventory[item.id].quantity += 1;
                    // Update average purchase price
                    gameState.inventory[item.id].purchasePrice = Math.floor(
                        (gameState.inventory[item.id].purchasePrice * (gameState.inventory[item.id].quantity - 1) + item.price) / 
                        gameState.inventory[item.id].quantity
                    );
                }
                
                updateCurrencyDisplay();
                updateInventoryDisplay();
                
                // Apply gold ingot bonus message if applicable
                let bonusMessage = currencyBonus > 0 ? `Ôºà‰∫´ÂèóÈáëÂ≠ê${currencyBonus * 100}%Ë¥≠‰π∞ÂäõÂä†ÊàêÔºâ` : '';
                showNotification(`ÊàêÂäüË¥≠‰π∞ ${item.name} ${bonusMessage}`);
                
                // Add experience based on rarity
                addExperience(item.rarity * 5);
                
                // Add purchase to statistics
                gameState.statistics.totalPurchases += 1;
                gameState.statistics.mostExpensivePurchase = Math.max(gameState.statistics.mostExpensivePurchase, item.price);
                
                // Flash the inventory tab to indicate new item
                if (document.querySelector('.tab-button[data-tab="inventory-tab"]') && !document.querySelector('#inventory-tab').classList.contains('active')) {
                    document.querySelector('.tab-button[data-tab="inventory-tab"]').classList.add('flash');
                    setTimeout(() => {
                        document.querySelector('.tab-button[data-tab="inventory-tab"]').classList.remove('flash');
                    }, 1000);
                }
            } else {
                const currencyName = item.currency === 'goldIngot' ? 'ÈáëÂ≠ê' : 
                                   item.currency === 'goldNote' ? 'ÈáëÁ•®' : 
                                   item.currency === 'silverIngot' ? 'Èì∂Â≠ê' : 'Èì∂Á•®';
                showNotification(`${currencyName}‰∏çË∂≥ÔºåÊó†Ê≥ïË¥≠‰π∞ÔºÅ`);
            }
        };

        // Sell item function
        const sellItem = (item) => {
            if (gameState.inventory[item.id] && gameState.inventory[item.id].quantity > 0) {
                gameState.inventory[item.id].quantity -= 1;
                
                // Calculate profit
                const purchasePrice = gameState.inventory[item.id].purchasePrice || item.price;
                const profit = item.resalePrice - purchasePrice;
                
                // Apply silver ingot bonus for faster trading
                const silverIngotBonus = 0.15; // 15% faster trading from silver ingot effect
                let bonusExperience = Math.max(1, Math.floor(item.rarity * 2 * (1 + silverIngotBonus)));
                
                // Add currency from sale
                if (item.currency === 'goldIngot') {
                    gameState.currencies.goldIngot += item.resalePrice;
                } else if (item.currency === 'goldNote') {
                    gameState.currencies.goldNote += item.resalePrice;
                } else if (item.currency === 'silverIngot') {
                    gameState.currencies.silverIngot += item.resalePrice;
                } else {
                    gameState.currencies.silverNote += item.resalePrice;
                }
                
                // Remove from inventory if quantity is 0
                if (gameState.inventory[item.id].quantity === 0) {
                    delete gameState.inventory[item.id];
                }
                
                updateCurrencyDisplay();
                updateInventoryDisplay();
                
                let profitMessage = profit > 0 ? 
                    `ÔºåËé∑Âà©${formatCurrency(profit, item.currency === 'goldIngot' || item.currency === 'goldNote' ? 'Èáë' : 'Èì∂')}ÔºÅ` : 
                    (profit < 0 ? `Ôºå‰∫èÊçü${formatCurrency(Math.abs(profit), item.currency === 'goldIngot' || item.currency === 'goldNote' ? 'Èáë' : 'Èì∂')}„ÄÇ` : '');
                    
                showNotification(`ÊàêÂäüÂá∫ÂîÆ ${item.name}${profitMessage}`);
                
                // Add experience based on rarity and profit
                addExperience(bonusExperience + (profit > 0 ? Math.floor(profit / 1000) : 0));
                
                // Add sale to statistics
                gameState.statistics.totalSales += 1;
                gameState.statistics.totalProfit += profit > 0 ? profit : 0;
                if (profit > gameState.statistics.biggestProfit) {
                    gameState.statistics.biggestProfit = profit;
                }
            }
        };

        // Update inventory display
        const updateInventoryDisplay = () => {
            const inventoryContent = document.getElementById('inventory-content');
            inventoryContent.innerHTML = '';
            
            if (Object.keys(gameState.inventory).length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'ÊöÇÊó†Áâ©ÂìÅÔºåÂø´ÂéªË¥≠Áâ©ÂêßÔºÅ';
                inventoryContent.appendChild(emptyMessage);
                return;
            }
            
            for (const itemId in gameState.inventory) {
                const item = gameState.inventory[itemId];
                const itemElement = document.createElement('div');
                itemElement.classList.add('inventory-item');
                
                let currencySymbol = '';
                if (item.currency === 'goldIngot' || item.currency === 'goldNote') {
                    currencySymbol = 'Èáë';
                } else {
                    currencySymbol = 'Èì∂';
                }
                
                // Calculate potential profit/loss
                const purchasePrice = item.purchasePrice || item.price;
                const potentialProfit = item.resalePrice - purchasePrice;
                let profitColor = potentialProfit > 0 ? 'green' : (potentialProfit < 0 ? 'red' : 'black');
                let profitSymbol = potentialProfit > 0 ? '‚Üë' : (potentialProfit < 0 ? '‚Üì' : '‚Üí');
                
                // Simplified rarity display for mobile
                let rarityStars = '';
                for (let i = 0; i < Math.min(item.rarity, 3); i++) {
                    rarityStars += '‚≠ê';
                }
                if (item.rarity > 3) {
                    rarityStars += '+' + (item.rarity - 3);
                }
                
                itemElement.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-details">
                        <h3>${item.name} ${rarityStars}</h3>
                        <p>Êï∞ÈáèÔºö${item.quantity}</p>
                        <p>‰π∞ÂÖ•Ôºö${formatCurrency(purchasePrice, currencySymbol)}</p>
                        <p>ÂçñÂá∫Ôºö${formatCurrency(item.resalePrice, currencySymbol)}</p>
                        <p style="color:${profitColor}">È¢ÑËÆ°${potentialProfit >= 0 ? 'Âà©Ê∂¶' : '‰∫èÊçü'}Ôºö${formatCurrency(Math.abs(potentialProfit), currencySymbol)} ${profitSymbol}</p>
                    </div>
                    <div class="item-actions">
                        <button class="sell-btn" data-id="${item.id}">Âá∫ÂîÆ</button>
                    </div>
                `;
                
                inventoryContent.appendChild(itemElement);
                
                // Add event listener for sell button
                itemElement.querySelector('.sell-btn').addEventListener('click', () => {
                    sellItem(item);
                });
            }
        };

        // Add experience and handle level up
        const addExperience = (amount) => {
            gameState.levelProgress += amount;
            
            // Check for level up
            if (gameState.levelProgress >= 100) {
                gameState.businessLevel += 1;
                gameState.levelProgress = gameState.levelProgress - 100;
                
                // Level up rewards
                const rewards = {
                    goldIngot: 10 * gameState.businessLevel * 1000, // 10 tael per level
                    silverIngot: 50 * gameState.businessLevel * 1000, // 50 tael per level
                    reputation: 5 * gameState.businessLevel
                };
                
                gameState.currencies.goldIngot += rewards.goldIngot;
                gameState.currencies.silverIngot += rewards.silverIngot;
                gameState.reputation += rewards.reputation;
                
                showAlert(`ÊÅ≠ÂñúÔºÅ‰Ω†ÁöÑÂïÜ‰∏öÁ≠âÁ∫ßÊèêÂçáÂà∞${gameState.businessLevel}Á∫ßÔºÅËé∑ÂæóÂ•ñÂä±Ôºö${formatCurrency(rewards.goldIngot, 'Èáë')}Ôºå${formatCurrency(rewards.silverIngot, 'Èì∂')}ÔºåÂ£∞Êúõ+${rewards.reputation}`, 'success');
                
                // Update store with new items at higher levels
                if (gameState.businessLevel === 3) {
                    storeItems.gold.push(
                        { id: 'royal_artifact', name: 'ÁöáÂÆ∂ÊñáÁâ©', icon: 'üëë', price: 500 * 1000, basePrice: 500 * 1000, currency: 'goldIngot', resalePrice: 450 * 1000, volatility: 0.3, trend: 0, rarity: 5 }
                    );
                    showNotification("Êñ∞ÂïÜÂìÅËß£ÈîÅÔºöÁöáÂÆ∂ÊñáÁâ©ÔºÅ");
                } else if (gameState.businessLevel === 5) {
                    storeItems.silverIngot.push(
                        { id: 'ancient_treasure', name: 'Âè§‰ª£ÂÆùËóè', icon: 'üèÜ', price: 2000 * 1000, basePrice: 2000 * 1000, currency: 'silverIngot', resalePrice: 1800 * 1000, volatility: 0.4, trend: 0, rarity: 5 }
                    );
                    showNotification("Êñ∞ÂïÜÂìÅËß£ÈîÅÔºöÂè§‰ª£ÂÆùËóèÔºÅ");
                }
            }
            
            // Update display
            updateCurrencyDisplay();
        };

        // Show notification
        const showNotification = (message) => {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.textContent = message;
            
            const mainElement = document.querySelector('main');
            mainElement.insertBefore(notification, mainElement.firstChild);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        };

        // Show alert
        const showAlert = (message, type) => {
            const alert = document.createElement('div');
            alert.classList.add('alert', `alert-${type}`);
            alert.textContent = message;
            
            const mainElement = document.querySelector('main');
            mainElement.insertBefore(alert, mainElement.firstChild);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 500);
            }, 5000);
        };

        // Show event notification with options
        const showEventNotification = (event) => {
            const eventContainer = document.getElementById('event-container');
            const eventElement = document.createElement('div');
            eventElement.classList.add('event-notification');
            
            let optionsHTML = '';
            event.options.forEach((option, index) => {
                optionsHTML += `<button class="event-option" data-option="${index}">${option.text}</button>`;
            });
            
            eventElement.innerHTML = `
                <h3>${event.name}</h3>
                <p>${event.description}</p>
                <div class="event-options">
                    ${optionsHTML}
                </div>
            `;
            
            eventContainer.appendChild(eventElement);
            
            // Add event listeners
            eventElement.querySelectorAll('.event-option').forEach((button, index) => {
                button.addEventListener('click', () => {
                    const success = event.options[index].effect();
                    
                    if (success) {
                        // Remove the event notification
                        eventElement.style.opacity = '0';
                        eventElement.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            if (eventElement.parentNode) {
                                eventElement.parentNode.removeChild(eventElement);
                            }
                        }, 500);
                    }
                    
                    updateCurrencyDisplay();
                    updateStoreDisplay();
                    updateInventoryDisplay();
                });
            });
        };

        // Generate a random event
        const generateRandomEvent = () => {
            if (Math.random() < 0.4) { // 40% chance for an event (increased from 30%)
                const randomEvent = gameEvents[Math.floor(Math.random() * gameEvents.length)];
                showEventNotification(randomEvent);
            }
        };

        // Update the mini market
        const updateMiniMarket = () => {
            const miniMarket = document.getElementById('mini-market');
            miniMarket.innerHTML = '';
            
            // Clear previous mini market items
            gameState.miniMarketItems = [];
            
            // 50% chance to have items in mini market
            if (Math.random() < 0.5) {
                // Pick 1-3 random rare items
                const numItems = Math.floor(Math.random() * 3) + 1;
                
                for (let i = 0; i < numItems; i++) {
                    const randomItem = rareItems[Math.floor(Math.random() * rareItems.length)];
                    
                    // Apply special discount (20-40% off)
                    const discount = 0.6 + Math.random() * 0.2;
                    const discountedPrice = Math.floor(randomItem.price * discount);
                    
                    // Create a copy of the item with discounted price
                    const discountedItem = {
                        ...randomItem,
                        price: discountedPrice,
                        originalPrice: randomItem.price,
                        discountPercent: Math.floor((1 - discount) * 100)
                    };
                    
                    // Add to mini market items
                    gameState.miniMarketItems.push(discountedItem);
                    
                    // Create mini market item element
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('mini-market-item');
                    
                    // Determine currency symbol
                    let currencySymbol = '';
                    switch(discountedItem.currency) {
                        case 'goldIngot': currencySymbol = 'Èáë'; break;
                        case 'goldNote': currencySymbol = 'ÈáëÁ•®'; break;
                        case 'silverIngot': currencySymbol = 'Èì∂'; break;
                        case 'silverNote': currencySymbol = 'Èì∂Á•®'; break;
                    }
                    
                    itemElement.innerHTML = `
                        <div class="item-icon">${discountedItem.icon}</div>
                        <div class="item-details">
                            <h3>${discountedItem.name} ‚≠ê${discountedItem.rarity}</h3>
                            <p>Áâπ‰ª∑: ${formatCurrency(discountedPrice, currencySymbol)} (-${discountedItem.discountPercent}%)</p>
                        </div>
                        <button class="mini-market-buy" data-index="${i}">Ë¥≠‰π∞</button>
                    `;
                    
                    miniMarket.appendChild(itemElement);
                }
                
                // Add event listeners for buy buttons
                document.querySelectorAll('.mini-market-buy').forEach(button => {
                    button.addEventListener('click', () => {
                        const index = parseInt(button.getAttribute('data-index'));
                        const item = gameState.miniMarketItems[index];
                        
                        if (gameState.currencies[item.currency] >= item.price) {
                            // Purchase item
                            gameState.currencies[item.currency] -= item.price;
                            
                            // Add to inventory
                            if (!gameState.inventory[item.id]) {
                                gameState.inventory[item.id] = {
                                    ...item,
                                    quantity: 1,
                                    purchasePrice: item.price
                                };
                            } else {
                                gameState.inventory[item.id].quantity += 1;
                                // Update average purchase price
                                gameState.inventory[item.id].purchasePrice = Math.floor(
                                    (gameState.inventory[item.id].purchasePrice * (gameState.inventory[item.id].quantity - 1) + item.price) / 
                                    gameState.inventory[item.id].quantity
                                );
                            }
                            
                            showNotification(`ÊàêÂäü‰ª•Áâπ‰ª∑Ë¥≠‰π∞ ${item.name}ÔºÅ`);
                            
                            // Remove item from mini market
                            button.closest('.mini-market-item').remove();
                            gameState.miniMarketItems.splice(index, 1);
                            
                            // Update remaining buttons' data-index
                            document.querySelectorAll('.mini-market-buy').forEach((btn, idx) => {
                                btn.setAttribute('data-index', idx);
                            });
                            
                            // Update displays
                            updateCurrencyDisplay();
                            updateInventoryDisplay();
                            
                            // Add experience based on rarity
                            addExperience(item.rarity * 10);
                            
                            // Add purchase to statistics
                            gameState.statistics.totalPurchases += 1;
                        } else {
                            const currencyName = item.currency === 'goldIngot' ? 'ÈáëÂ≠ê' : 
                                            item.currency === 'goldNote' ? 'ÈáëÁ•®' : 
                                            item.currency === 'silverIngot' ? 'Èì∂Â≠ê' : 'Èì∂Á•®';
                            showNotification(`${currencyName}‰∏çË∂≥ÔºåÊó†Ê≥ïË¥≠‰π∞ÔºÅ`);
                        }
                    });
                });
                
                // Show badge to indicate new items
                document.getElementById('mini-market-badge').style.display = 'inline-block';
            } else {
                // No items in mini market
                miniMarket.innerHTML = '<p>ÂΩìÂâçÊ≤°ÊúâÁâπ‰ª∑ÂïÜÂìÅÔºåÁ≠âÂæÖ‰∏ãÊ¨°Â∏ÇÂú∫Êõ¥Êñ∞„ÄÇ</p>';
                document.getElementById('mini-market-badge').style.display = 'none';
            }
        };

        // Update loan system
        const updateLoanSystem = () => {
            const loanSystem = document.getElementById('loan-system');
            loanSystem.innerHTML = '';
            
            // First display active loans
            if (gameState.activeLoans.length > 0) {
                const activeLoanTitle = document.createElement('h4');
                activeLoanTitle.textContent = 'ÂΩìÂâçË¥∑Ê¨æ';
                loanSystem.appendChild(activeLoanTitle);
                
                gameState.activeLoans.forEach((loan, index) => {
                    const loanElement = document.createElement('div');
                    loanElement.classList.add('loan-option', 'loan-active');
                    
                    // Calculate remaining amount
                    const totalAmount = Math.floor(loan.amount * (1 + loan.interestRate));
                    const currencySymbol = loan.currency === 'goldIngot' ? 'Èáë' : 'Èì∂';
                    
                    loanElement.innerHTML = `
                        <h4>${loan.name}</h4>
                        <p>Ââ©‰ΩôËøòÊ¨æÊó∂Èó¥: ${loan.remainingCycles}‰∏™Â∏ÇÂú∫Âë®Êúü</p>
                        <p>ÈúÄËøòÊ¨æÈáëÈ¢ù: ${formatCurrency(totalAmount, currencySymbol)}</p>
                        <button class="repay-loan-btn" data-index="${index}">Á´ãÂç≥ËøòÊ¨æ</button>
                    `;
                    
                    loanSystem.appendChild(loanElement);
                });
                
                // Add event listeners for repay buttons
                document.querySelectorAll('.repay-loan-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const index = parseInt(button.getAttribute('data-index'));
                        const loan = gameState.activeLoans[index];
                        const totalAmount = Math.floor(loan.amount * (1 + loan.interestRate));
                        
                        if (gameState.currencies[loan.currency] >= totalAmount) {
                            // Repay loan
                            gameState.currencies[loan.currency] -= totalAmount;
                            
                            // Remove loan from active loans
                            gameState.activeLoans.splice(index, 1);
                            
                            showNotification(`ÊàêÂäüËøòÊ∏ÖË¥∑Ê¨æÔºÅ`);
                            updateCurrencyDisplay();
                            updateLoanSystem();
                        } else {
                            showNotification(`‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑ${loan.currency === 'goldIngot' ? 'ÈáëÂ≠ê' : 'Èì∂Â≠ê'}Êù•ËøòÊ¨æ„ÄÇ`);
                        }
                    });
                });
            }
            
            // Then display available loans
            const availableLoanTitle = document.createElement('h4');
            availableLoanTitle.textContent = 'ÂèØÁî≥ËØ∑Ë¥∑Ê¨æ';
            loanSystem.appendChild(availableLoanTitle);
            
            const availableLoans = loanOptions.filter(loan => loan.minBusinessLevel <= gameState.businessLevel);
            
            if (availableLoans.length === 0) {
                const noLoanMsg = document.createElement('p');
                noLoanMsg.textContent = `ÂΩìÂâçÂïÜ‰∏öÁ≠âÁ∫ß ${gameState.businessLevel} ÊöÇÊó†ÂèØÁî®Ë¥∑Ê¨æ„ÄÇÊèêÂçáÁ≠âÁ∫ßËß£ÈîÅÊõ¥Â§öË¥∑Ê¨æÈÄâÈ°πÔºÅ`;
                loanSystem.appendChild(noLoanMsg);
            } else {
                availableLoans.forEach(loan => {
                    // Skip if player already has this type of loan
                    if (gameState.activeLoans.some(l => l.id === loan.id)) {
                        return;
                    }
                    
                    const loanElement = document.createElement('div');
                    loanElement.classList.add('loan-option');
                    
                    const currencySymbol = loan.currency === 'goldIngot' ? 'Èáë' : 'Èì∂';
                    const totalAmount = Math.floor(loan.amount * (1 + loan.interestRate));
                    
                    loanElement.innerHTML = `
                        <h4>${loan.name}</h4>
                        <p>Ë¥∑Ê¨æÈáëÈ¢ù: ${formatCurrency(loan.amount, currencySymbol)}</p>
                        <p>Âà©Áéá: ${loan.interestRate * 100}%</p>
                        <p>ÊúüÈôê: ${loan.durationCycles}‰∏™Â∏ÇÂú∫Âë®Êúü</p>
                        <p>Âà∞ÊúüÂ∫îËøò: ${formatCurrency(totalAmount, currencySymbol)}</p>
                        <button class="take-loan-btn" data-id="${loan.id}">Áî≥ËØ∑Ë¥∑Ê¨æ</button>
                    `;
                    
                    loanSystem.appendChild(loanElement);
                });
                
                // Add event listeners for loan buttons
                document.querySelectorAll('.take-loan-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const loanId = button.getAttribute('data-id');
                        const loan = loanOptions.find(l => l.id === loanId);
                        
                        // Check if player already has too many loans
                        if (gameState.activeLoans.length >= 2) {
                            showNotification(`‰Ω†Â∑≤ÁªèÊúâ ${gameState.activeLoans.length} Á¨îË¥∑Ê¨æ‰∫ÜÔºåÊó†Ê≥ïÁî≥ËØ∑Êõ¥Â§ö„ÄÇ`);
                            return;
                        }
                        
                        // Create active loan
                        const activeLoan = {
                            ...loan,
                            remainingCycles: loan.durationCycles
                        };
                        
                        gameState.activeLoans.push(activeLoan);
                        
                        // Add loan amount to currency
                        gameState.currencies[loan.currency] += loan.amount;
                        
                        showNotification(`ÊàêÂäüÁî≥ËØ∑Ë¥∑Ê¨æÔºåËé∑Âæó ${formatCurrency(loan.amount, loan.currency === 'goldIngot' ? 'Èáë' : 'Èì∂')}`);
                        updateCurrencyDisplay();
                        updateLoanSystem();
                    });
                });
            }
        };

        // Update prediction system
        const updatePredictionSystem = () => {
            // Populate item dropdown
            const predictionItem = document.getElementById('prediction-item');
            
            // Clear current options except the first one
            while (predictionItem.options.length > 1) {
                predictionItem.remove(1);
            }
            
            // Add all items
            for (const category in storeItems) {
                storeItems[category].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name} ${item.icon}`;
                    predictionItem.appendChild(option);
                });
            }
            
            // Add event listener to make prediction button
            document.getElementById('make-prediction').addEventListener('click', () => {
                const itemId = document.getElementById('prediction-item').value;
                const trend = document.getElementById('prediction-trend').value;
                const amount = parseInt(document.getElementById('prediction-amount').value) || 0;
                
                if (!itemId) {
                    showNotification("ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂïÜÂìÅËøõË°åÈ¢ÑÊµã„ÄÇ");
                    return;
                }
                
                if (amount < 1000) {
                    showNotification("ÊäïÊ≥®ÈáëÈ¢ùËá≥Â∞ë‰∏∫1‰∏§Èì∂Á•®„ÄÇ");
                    return;
                }
                
                if (gameState.currencies.silverNote < amount) {
                    showNotification("Èì∂Á•®‰ΩôÈ¢ù‰∏çË∂≥ÔºåÊó†Ê≥ïÂÆåÊàêÊäïÊ≥®„ÄÇ");
                    return;
                }
                
                // Find the item
                let predictedItem = null;
                for (const category in storeItems) {
                    const found = storeItems[category].find(item => item.id === itemId);
                    if (found) {
                        predictedItem = found;
                        break;
                    }
                }
                
                if (!predictedItem) {
                    showNotification("Êó†Ê≥ïÊâæÂà∞ÊåáÂÆöÂïÜÂìÅ„ÄÇ");
                    return;
                }
                
                // Take the bet
                gameState.currencies.silverNote -= amount;
                
                // Create prediction
                const prediction = {
                    item: predictedItem,
                    trend: trend,
                    amount: amount,
                    currentPrice: predictedItem.price,
                    marketCycles: 3 // Check after 3 market cycles
                };
                
                gameState.activePredictions.push(prediction);
                
                showNotification(`‰Ω†È¢ÑÊµã ${predictedItem.name} Â∞Ü‰ºö${trend === 'up' ? '‰∏äÊ∂®' : '‰∏ãË∑å'}ÔºåÊäïÊ≥® ${formatCurrency(amount, 'Èì∂Á•®')}„ÄÇÁªìÊûúÂ∞ÜÂú®3‰∏™Â∏ÇÂú∫Âë®ÊúüÂêéÊè≠Êôì„ÄÇ`);
                updateCurrencyDisplay();
                
                // Clear input
                document.getElementById('prediction-amount').value = '';
            });
            
            // Display active predictions
            const predictionResults = document.getElementById('prediction-results');
            predictionResults.innerHTML = '';
            
            if (gameState.activePredictions.length > 0) {
                const predictionsTitle = document.createElement('h4');
                predictionsTitle.textContent = 'ËøõË°å‰∏≠ÁöÑÈ¢ÑÊµã';
                predictionResults.appendChild(predictionsTitle);
                
                gameState.activePredictions.forEach(prediction => {
                    const predictionElement = document.createElement('div');
                    predictionElement.classList.add('prediction-item');
                    
                    predictionElement.innerHTML = `
                        <p>${prediction.item.name} ${prediction.item.icon} - È¢ÑÊµã${prediction.trend === 'up' ? '‰∏äÊ∂®' : '‰∏ãË∑å'}</p>
                        <p>ÊäïÊ≥®: ${formatCurrency(prediction.amount, 'Èì∂Á•®')}</p>
                        <p>Ââ©‰Ωô: ${prediction.marketCycles}‰∏™Â∏ÇÂú∫Âë®Êúü</p>
                    `;
                    
                    predictionResults.appendChild(predictionElement);
                });
            }
        };

        // Check predictions
        const checkPredictions = () => {
            const predictionsToBeChecked = [];
            
            // Reduce market cycles for all predictions and find the ones to check
            gameState.activePredictions.forEach(prediction => {
                prediction.marketCycles--;
                
                if (prediction.marketCycles <= 0) {
                    predictionsToBeChecked.push(prediction);
                }
            });
            
            // Process predictions to be checked
            for (const prediction of predictionsToBeChecked) {
                // Find the current item price
                let currentItem = null;
                for (const category in storeItems) {
                    const found = storeItems[category].find(item => item.id === prediction.item.id);
                    if (found) {
                        currentItem = found;
                        break;
                    }
                }
                
                if (!currentItem) {
                    showNotification(`${prediction.item.name} Êó†Ê≥ïÊâæÂà∞ÔºåÈ¢ÑÊµãÂèñÊ∂à„ÄÇ`);
                    continue;
                }
                
                // Check if prediction was correct
                const priceDifference = currentItem.price - prediction.currentPrice;
                const actualTrend = priceDifference > 0 ? 'up' : (priceDifference < 0 ? 'down' : 'stable');
                const isCorrect = (prediction.trend === 'up' && priceDifference > 0) || (prediction.trend === 'down' && priceDifference < 0);
                
                if (isCorrect) {
                    // Pay out 2x bet
                    const payout = prediction.amount * 2;
                    gameState.currencies.silverNote += payout;
                    
                    showNotification(`‰Ω†ÂØπ ${prediction.item.name} ÁöÑÈ¢ÑÊµãÊ≠£Á°ÆÔºÅËµ¢Âæó ${formatCurrency(payout, 'Èì∂Á•®')}`);
                    
                    // Track statistics
                    if (!gameState.statistics.successfulPredictions) {
                        gameState.statistics.successfulPredictions = 1;
                    } else {
                        gameState.statistics.successfulPredictions++;
                    }
                    
                    // Add experience
                    addExperience(20);
                } else {
                    showNotification(`‰Ω†ÂØπ ${prediction.item.name} ÁöÑÈ¢ÑÊµãÈîôËØØÔºåÊçüÂ§±‰∫ÜÊäïÊ≥®ÈáëÈ¢ù„ÄÇ`);
                }
                
                // Remove the prediction
                gameState.activePredictions = gameState.activePredictions.filter(p => p !== prediction);
            }
            
            updateCurrencyDisplay();
            updatePredictionSystem();
        };

        // Setup achievements
        const setupAchievements = () => {
            const achievementsContainer = document.getElementById('achievements-container');
            achievementsContainer.innerHTML = '';
            
            achievementsList.forEach(achievement => {
                const isUnlocked = gameState.unlockedAchievements.includes(achievement.id);
                
                const achievementElement = document.createElement('div');
                achievementElement.classList.add('achievement');
                if (!isUnlocked) {
                    achievementElement.classList.add('achievement-locked');
                }
                
                achievementElement.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-details">
                        <h4>${achievement.name}${isUnlocked ? ' ‚úì' : ''}</h4>
                        <p>${achievement.description}</p>
                        <p><small>${isUnlocked ? 'Â∑≤Ëß£ÈîÅ' : 'Êú™Ëß£ÈîÅ'}</small></p>
                    </div>
                `;
                
                achievementsContainer.appendChild(achievementElement);
            });
        };

        // Check achievements
        const checkAchievements = () => {
            achievementsList.forEach(achievement => {
                // Skip already unlocked achievements
                if (gameState.unlockedAchievements.includes(achievement.id)) {
                    return;
                }
                
                // Check if requirement is met
                if (achievement.requirement()) {
                    // Unlock achievement
                    gameState.unlockedAchievements.push(achievement.id);
                    
                    // Give reward
                    gameState.currencies.silverNote += achievement.reward;
                    
                    showAlert(`ÊàêÂ∞±Ëß£ÈîÅÔºö${achievement.name}ÔºÅÂ•ñÂä± ${formatCurrency(achievement.reward, 'Èì∂Á•®')}`, 'success');
                    
                    // Add experience
                    addExperience(25);
                    
                    // Update achievements display
                    setupAchievements();
                }
            });
        };

        // Update market with random price fluctuations
        const updateMarket = () => {
            let newsContent = '';
            
            // Apply seasonal effects
            const season = seasons[gameState.date.season];
            newsContent = `${gameState.date.year}Âπ¥${season.name}Â≠£Ôºö`;
            
            // Apply seasonal item effects
            if (season.effect.type === 'items') {
                season.effect.target.forEach(itemId => {
                    // Find the item in all stores
                    for (let category in storeItems) {
                        const item = storeItems[category].find(i => i.id === itemId);
                        if (item) {
                            item.trend += season.effect.trend;
                        }
                    }
                });
                
                newsContent += `${season.name}Â≠£ËäÇÊÄßÂïÜÂìÅÈúÄÊ±ÇÂ¢ûÂä†„ÄÇ`;
            }
            
            // Apply active events effects
            gameState.events = gameState.events.filter(event => event.duration > 0);
            
            if (gameState.events.length > 0) {
                newsContent += ' ';
                gameState.events.forEach(event => {
                    newsContent += `${event.name}Ôºö${event.description} `;
                    
                    // Apply event effects
                    if (event.effect.type === 'global') {
                        // Apply to all items
                        for (let category in storeItems) {
                            storeItems[category].forEach(item => {
                                item.volatility = Math.max(0.05, item.volatility + event.effect.volatility);
                                item.trend += event.effect.trend;
                            });
                        }
                    } else if (event.effect.type === 'category') {
                        // Apply to specific category
                        if (storeItems[event.effect.target]) {
                            storeItems[event.effect.target].forEach(item => {
                                item.volatility = Math.max(0.05, item.volatility + event.effect.volatility);
                                item.trend += event.effect.trend;
                            });
                        }
                    } else if (event.effect.type === 'items') {
                        // Apply to specific items
                        event.effect.target.forEach(itemId => {
                            // Find the item in all stores
                            for (let category in storeItems) {
                                const item = storeItems[category].find(i => i.id === itemId);
                                if (item) {
                                    item.trend += event.effect.trend;
                                }
                            }
                        });
                    } else if (event.effect.type === 'currency') {
                        // Apply to currency
                        // Effect will be applied during transactions
                    }
                    
                    // Decrease duration
                    event.duration--;
                });
            } else {
                newsContent += 'Â∏ÇÂú∫Âπ≥Á®≥„ÄÇ';
            }
            
            // Update all prices based on trend and volatility
            for (let category in storeItems) {
                storeItems[category].forEach(item => {
                    // Base fluctuation based on volatility - more extreme now
                    const fluctuation = (Math.random() * 2 - 1) * item.volatility * 2;
                    
                    // Add trend component
                    const trendComponent = item.trend;
                    
                    // Silver note market info bonus - reduce randomness
                    const marketInfoBonus = category === 'silverNote' ? 0.25 : 0; // 25% better market info
                    
                    // Calculate total price change
                    const totalChange = fluctuation * (1 - marketInfoBonus) + trendComponent;
                    
                    // Update price
                    item.price = Math.max(
                        Math.floor(item.price * (1 + totalChange)),
                        Math.floor(item.basePrice * 0.5) // Price won't go below 50% of base
                    );
                    
                    // Update resale price (except for notes)
                    if (item.currency !== 'goldNote' && item.currency !== 'silverNote') {
                        item.resalePrice = Math.max(
                            Math.floor(item.price * 0.8),
                            Math.floor(item.basePrice * 0.4) // Resale won't go below 40% of base
                        );
                    }
                    
                    // Gradually reset trend toward zero for next cycle
                    item.trend = item.trend * 0.8;
                });
            }
            
            // Update market news
            document.getElementById('market-news-content').textContent = newsContent;
            
            // Update displays
            updateStoreDisplay();
            updateInventoryDisplay();
            
            // Check loans
            updateLoans();
            
            // Check predictions
            checkPredictions();
            
            // Update mini market (occasionally)
            if (Math.random() < 0.3) {
                updateMiniMarket();
            }
            
            // Small chance for random event
            generateRandomEvent();
        };

        // Update loans
        const updateLoans = () => {
            // Check for any loans that need to be repaid
            const loansToBePaid = [];
            
            gameState.activeLoans.forEach(loan => {
                loan.remainingCycles--;
                
                if (loan.remainingCycles <= 0) {
                    loansToBePaid.push(loan);
                }
            });
            
            // Process loans to be paid
            for (const loan of loansToBePaid) {
                const totalAmount = Math.floor(loan.amount * (1 + loan.interestRate));
                
                if (gameState.currencies[loan.currency] >= totalAmount) {
                    // Pay back loan
                    gameState.currencies[loan.currency] -= totalAmount;
                    showNotification(`Ë¥∑Ê¨æ ${loan.name} Âà∞ÊúüÔºåËá™Âä®ÂÅøËøò ${formatCurrency(totalAmount, loan.currency === 'goldIngot' ? 'Èáë' : 'Èì∂')}`);
                } else {
                    // Cannot pay back - penalty
                    const available = gameState.currencies[loan.currency];
                    gameState.currencies[loan.currency] = 0;
                    
                    // Calculate remaining debt
                    const remainingDebt = totalAmount - available;
                    
                    // Apply penalty to reputation
                    gameState.reputation = Math.max(0, gameState.reputation - 20);
                    
                    showAlert(`Ë¥∑Ê¨æ ${loan.name} Âà∞ÊúüÔºå‰ΩÜ‰Ω†Ê≤°ÊúâË∂≥Â§üÁöÑËµÑÈáëÂÅøËøòÔºÅ‰ø°Ë™âÂèóÊçüÔºåÂ£∞Êúõ-20„ÄÇ`, 'danger');
                    
                    // Create a new loan with higher interest
                    const newLoan = {
                        ...loan,
                        amount: remainingDebt,
                        interestRate: loan.interestRate * 1.5,
                        remainingCycles: 5,
                        name: loan.name + "ÔºàÈÄæÊúüÔºâ"
                    };
                    
                    gameState.activeLoans.push(newLoan);
                    showNotification(`Êú™ÂÅøËøòÁöÑ ${formatCurrency(remainingDebt, loan.currency === 'goldIngot' ? 'Èáë' : 'Èì∂')} Â∑≤ËΩ¨‰∏∫È´òÂà©Ë¥∑ÔºåÂà©ÁéáÊèêÈ´òÂà∞ ${(loan.interestRate * 1.5 * 100).toFixed(0)}%`);
                }
                
                // Remove loan from active loans
                gameState.activeLoans = gameState.activeLoans.filter(l => l !== loan);
            }
            
            updateCurrencyDisplay();
            updateLoanSystem();
        };

        // Advance game time
        const advanceTime = () => {
            // Advance season
            gameState.date.season = (gameState.date.season + 1) % 4;
            
            // If we completed a year, advance the year
            if (gameState.date.season === 0) {
                gameState.date.year += 1;
            }
            
            // Random market event
            if (Math.random() < 0.4) { // 40% chance for a market event (increased from 30%)
                const randomEvent = marketEvents[Math.floor(Math.random() * marketEvents.length)];
                gameState.events.push({...randomEvent}); // Clone the event
                showNotification(`Â∏ÇÂú∫‰∫ã‰ª∂Ôºö${randomEvent.name} - ${randomEvent.description}`);
            }
            
            // Update market
            updateMarket();
            
            // Update display
            updateCurrencyDisplay();
        };

        // Handle market timer
        const updateMarketTimer = () => {
            gameState.timerCount--;
            document.getElementById('market-timer').textContent = `Â∏ÇÂú∫Êõ¥Êñ∞Ôºö${gameState.timerCount}s`;
            
            if (gameState.timerCount <= 0) {
                // Reset timer
                gameState.timerCount = 15; // 15 seconds per update, faster pace!
                
                // Advance time
                advanceTime();
            }
        };

        // Toggle section collapse
        const toggleSection = (sectionId) => {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.section-content');
            const toggle = section.querySelector('.section-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                gameState.sectionCollapsed[sectionId.replace('-section', '')] = false;
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                gameState.sectionCollapsed[sectionId.replace('-section', '')] = true;
            }
        };

        // Setup tabs
        const setupTabs = () => {
            // Get tab buttons and content
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Add click event to tab buttons
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Get the tab to show
                    const tabToShow = button.getAttribute('data-tab');
                    
                    // Hide all tabs and remove active class from buttons
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                    });
                    
                    // Show the selected tab and mark button as active
                    document.getElementById(tabToShow).classList.add('active');
                    button.classList.add('active');
                });
            });
        };

        // Setup quick actions
        const setupQuickActions = () => {
            // Show/hide quick actions
            document.getElementById('quick-action-button').addEventListener('click', () => {
                document.getElementById('quick-actions').classList.toggle('visible');
            });
            
            // Quick buy
            document.getElementById('quick-buy').addEventListener('click', () => {
                // Find items with positive trend
                let potentialItems = [];
                
                for (let category in storeItems) {
                    storeItems[category].forEach(item => {
                        if (item.trend > 0.1) {
                            potentialItems.push(item);
                        }
                    });
                }
                
                if (potentialItems.length === 0) {
                    showNotification("ÂΩìÂâçÊ≤°ÊúâÊòéÊòæ‰∏äÊ∂®Ë∂ãÂäøÁöÑÂïÜÂìÅ„ÄÇ");
                    return;
                }
                
                // Sort by trend, highest first
                potentialItems.sort((a, b) => b.trend - a.trend);
                
                // Try to buy the first item
                const itemToBuy = potentialItems[0];
                
                if (gameState.currencies[itemToBuy.currency] >= itemToBuy.price) {
                    buyItem(itemToBuy);
                } else {
                    showNotification(`Ê≤°ÊúâË∂≥Â§üÁöÑ${itemToBuy.currency === 'goldIngot' ? 'ÈáëÂ≠ê' : itemToBuy.currency === 'goldNote' ? 'ÈáëÁ•®' : itemToBuy.currency === 'silverIngot' ? 'Èì∂Â≠ê' : 'Èì∂Á•®'}Ë¥≠‰π∞ ${itemToBuy.name}`);
                }
                
                document.getElementById('quick-actions').classList.remove('visible');
            });
            
            // Quick sell
            document.getElementById('quick-sell').addEventListener('click', () => {
                // Find items with negative trend
                let soldCount = 0;
                let totalProfit = 0;
                
                for (const itemId in gameState.inventory) {
                    const item = gameState.inventory[itemId];
                    
                    // Find the current item in store
                    let storeItem = null;
                    for (let category in storeItems) {
                        const found = storeItems[category].find(i => i.id === itemId);
                        if (found) {
                            storeItem = found;
                            break;
                        }
                    }
                    
                    if (storeItem && storeItem.trend < -0.1) {
                        // Get profit before selling
                        const purchasePrice = item.purchasePrice || storeItem.price;
                        const profit = storeItem.resalePrice - purchasePrice;
                        totalProfit += profit * item.quantity;
                        
                        // Sell all quantity
                        for (let i = 0; i < item.quantity; i++) {
                            soldCount++;
                            
                            // Add currency from sale
                            if (storeItem.currency === 'goldIngot') {
                                gameState.currencies.goldIngot += storeItem.resalePrice;
                            } else if (storeItem.currency === 'goldNote') {
                                gameState.currencies.goldNote += storeItem.resalePrice;
                            } else if (storeItem.currency === 'silverIngot') {
                                gameState.currencies.silverIngot += storeItem.resalePrice;
                            } else {
                                gameState.currencies.silverNote += storeItem.resalePrice;
                            }
                            
                            // Add to statistics
                            gameState.statistics.totalSales += 1;
                            if (profit > 0) {
                                gameState.statistics.totalProfit += profit;
                                if (profit > gameState.statistics.biggestProfit) {
                                    gameState.statistics.biggestProfit = profit;
                                }
                            }
                        }
                        
                        // Remove from inventory
                        delete gameState.inventory[itemId];
                    }
                }
                
                if (soldCount > 0) {
                    const profitMsg = totalProfit > 0 ? `ÔºåËé∑Âà© ${formatCurrency(totalProfit, 'Èì∂')}` : totalProfit < 0 ? `Ôºå‰∫èÊçü ${formatCurrency(Math.abs(totalProfit), 'Èì∂')}` : '';
                    showNotification(`‰∏ÄÈîÆÂá∫ÂîÆ‰∫Ü ${soldCount} ‰ª∂‰∏ãË∑åË∂ãÂäøÂïÜÂìÅ${profitMsg}`);
                    updateCurrencyDisplay();
                    updateInventoryDisplay();
                    addExperience(soldCount * 5);
                } else {
                    showNotification("Ê≤°ÊúâÂèëÁé∞‰∏ãË∑åË∂ãÂäøÁöÑÂïÜÂìÅÊàñÂ∫ìÂ≠ò‰∏∫Á©∫„ÄÇ");
                }
                
                document.getElementById('quick-actions').classList.remove('visible');
            });
            
            // Quick exchange
            document.getElementById('quick-exchange').addEventListener('click', () => {
                // Calculate optimal exchanges
                if (gameState.currencies.goldIngot > 20000) { // More than 20 tael gold
                    const exchangeAmount = Math.floor(gameState.currencies.goldIngot * 0.3); // Exchange 30%
                    gameState.currencies.goldIngot -= exchangeAmount;
                    gameState.currencies.silverIngot += exchangeAmount * 100;
                    showNotification(`Âø´ÈÄüÂÖëÊç¢Ôºö${formatCurrency(exchangeAmount, 'Èáë')} ‚Üí ${formatCurrency(exchangeAmount * 100, 'Èì∂')}`);
                }
                
                if (gameState.currencies.silverIngot > 100000) { // More than 100 tael silver
                    const exchangeAmount = Math.floor(gameState.currencies.silverIngot * 0.2); // Exchange 20%
                    gameState.currencies.silverIngot -= exchangeAmount;
                    gameState.currencies.silverNote += Math.floor(exchangeAmount * 0.95); // 5% fee
                    showNotification(`Âø´ÈÄüÂÖëÊç¢Ôºö${formatCurrency(exchangeAmount, 'Èì∂')} ‚Üí ${formatCurrency(Math.floor(exchangeAmount * 0.95), 'Èì∂Á•®')}`);
                }
                
                updateCurrencyDisplay();
                setupCurrencySection();
                document.getElementById('quick-actions').classList.remove('visible');
            });
            
            // Quick egg
            document.getElementById('quick-egg').addEventListener('click', () => {
                if (gameState.currencies.goldIngot >= gameState.eggCost) {
                    gameState.currencies.goldIngot -= gameState.eggCost;
                    crackEgg(false);
                } else if (gameState.currencies.goldNote >= gameState.eggCost) {
                    gameState.currencies.goldNote -= gameState.eggCost;
                    crackEgg(true);
                } else {
                    showNotification("ÈáëÂ≠êÂíåÈáëÁ•®‰∏çË∂≥ÔºåÊó†Ê≥ïÁ†∏ÈáëËõã„ÄÇ");
                }
                
                document.getElementById('quick-actions').classList.remove('visible');
            });
        };

        // Initialize game
        const initGame = () => {
            updateCurrencyDisplay();
            setupCurrencySection();
            setupGoldEggSection();
            setupStoreTabs();
            setupTabs();
            updateStoreDisplay();
            updateInventoryDisplay();
            updateMiniMarket();
            updateLoanSystem();
            setupAchievements();
            updatePredictionSystem();
            setupQuickActions();
            
            // Initialize section collapse state
            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const sectionId = toggle.closest('section').id;
                    toggleSection(sectionId);
                });
                
                // Set initial state
                const sectionId = toggle.closest('section').id;
                const sectionKey = sectionId.replace('-section', '');
                if (gameState.sectionCollapsed[sectionKey]) {
                    const content = document.getElementById(sectionId).querySelector('.section-content');
                    content.classList.add('collapsed');
                    toggle.classList.add('collapsed');
                }
            });
            
            // Start game timer - updates market every 15 seconds
            setInterval(updateMarketTimer, 1000);
            
            // Welcome message
            showAlert("Ê¨¢ËøéÊù•Âà∞Â§©‰π¶Â∞èÊëäÔºÅËØ∑ÂºÄÂßã‰Ω†ÁöÑÂïÜ‰∏öÂÜíÈô©ÔºÅ", 'success');
        };

        // Start the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
